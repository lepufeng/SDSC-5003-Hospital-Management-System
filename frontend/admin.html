
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Center - Hospital Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { 
            background: linear-gradient(135deg, #f46b45 0%, #eea849 100%);
            color: white;
            min-height: 100vh;
            padding-top: 20px;
        }
        .nav-link { color: white !important; padding: 12px 20px; }
        .nav-link:hover { background: rgba(255,255,255,0.1); }
        .nav-link.active { background: rgba(255,255,255,0.2); }
        .card { border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .stat-card { 
            border-left: 5px solid; 
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-1 { border-left-color: #0d6efd; }
        .stat-2 { border-left-color: #198754; }
        .stat-3 { border-left-color: #ffc107; }
        .stat-4 { border-left-color: #dc3545; }
        /* Search form styles */
        .search-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .search-form h6 {
            margin-bottom: 15px;
            color: #495057;
            font-weight: 600;
        }
        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .export-btn:hover {
            background: #218838;
        }
        /* Advanced search toggle */
        .advanced-search-toggle {
            cursor: pointer;
            color: #0d6efd;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }
        .advanced-search-toggle:hover {
            text-decoration: underline;
        }
        /* Modal styles */
        .modal-body .form-label {
            font-weight: 500;
            margin-bottom: 0.3rem;
        }
        .modal-body .form-control:focus,
        .modal-body .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .modal-body .required:after {
            content: " *";
            color: #dc3545;
        }
        /* API status styles */
        .api-status-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
        }
        /* Error alert styles */
        .api-error-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        /* Quick stats for search results */
        .quick-stats {
            background: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }
    </style>
    <!-- Global API Configuration -->
    <script>
        // API configuration - all use /admin/ prefix
        const API_CONFIG = {
            BASE_URL: 'http://localhost:5000',
            MOCK_MODE: false, // Set to true to enable mock data
            TIMEOUT: 10000, // 10-second timeout
            RETRY_COUNT: 1, // Retry count
            ENDPOINTS: {
                PATIENTS: '/admin/patients',
                DOCTORS: '/admin/doctors',
                APPOINTMENTS: '/admin/appointments',
                BILLING: '/admin/billing'
            }
        };
        
        // Mock data (when backend is unavailable)
        const MOCK_DATA = {
            patients: [
                { patient_id: 1, first_name: 'John', last_name: 'Zhang', gender: 'M', date_of_birth: '1990-01-01', contact_number: '13800138001', email: 'john@example.com', address: 'Beijing', insurance_provider: 'China Life', insurance_number: 'INS001', registration_date: '2024-01-15' },
                { patient_id: 2, first_name: 'Lisa', last_name: 'Li', gender: 'F', date_of_birth: '1985-05-20', contact_number: '13800138002', email: 'lisa@example.com', address: 'Shanghai', insurance_provider: 'Ping An', insurance_number: 'INS002', registration_date: '2024-01-16' },
                { patient_id: 3, first_name: 'David', last_name: 'Wang', gender: 'M', date_of_birth: '1995-08-15', contact_number: '13800138003', email: 'david@example.com', address: 'Guangzhou', insurance_provider: 'Pacific Insurance', insurance_number: 'INS003', registration_date: '2024-01-17' }
            ],
            doctors: [
                { doctor_id: 1, first_name: 'Michael', last_name: 'Zhang', specialization: 'Internal Medicine', years_experience: 12, phone_number: '13900139001', email: 'michael@hospital.com', hospital_branch: 'Main Hospital', bio: 'Chief physician, specializes in cardiovascular diseases' },
                { doctor_id: 2, first_name: 'Sarah', last_name: 'Li', specialization: 'Pediatrics', years_experience: 8, phone_number: '13900139002', email: 'sarah@hospital.com', hospital_branch: 'Branch A', bio: 'Deputy chief physician, specializes in children\'s common diseases' },
                { doctor_id: 3, first_name: 'William', last_name: 'Wang', specialization: 'Surgery', years_experience: 15, phone_number: '13900139003', email: 'william@hospital.com', hospital_branch: 'Main Hospital', bio: 'Chief surgeon, specializes in minimally invasive surgery' }
            ],
            appointments: [
                { appointment_id: 1, patient_id: 1, patient_first_name: 'John', patient_last_name: 'Zhang', doctor_id: 1, doctor_first_name: 'Michael', doctor_last_name: 'Zhang', appointment_date: '2024-01-20', appointment_time: '10:00', reason_for_visit: 'Regular Checkup', status: 'Completed' },
                { appointment_id: 2, patient_id: 2, patient_first_name: 'Lisa', patient_last_name: 'Li', doctor_id: 2, doctor_first_name: 'Sarah', doctor_last_name: 'Li', appointment_date: '2024-01-21', appointment_time: '14:30', reason_for_visit: 'Follow-up', status: 'Scheduled' },
                { appointment_id: 3, patient_id: 3, patient_first_name: 'David', patient_last_name: 'Wang', doctor_id: 3, doctor_first_name: 'William', doctor_last_name: 'Wang', appointment_date: '2024-01-22', appointment_time: '09:00', reason_for_visit: 'Treatment', status: 'In Progress' }
            ],
            billing: [
                { bill_id: 1, patient_id: 1, patient_first_name: 'John', patient_last_name: 'Zhang', bill_date: '2024-01-20', description: 'Consultation + Medicine', amount: 350.50, payment_method: 'WeChat Pay', payment_status: 'Paid', notes: 'Regular checkup fee' },
                { bill_id: 2, patient_id: 2, patient_first_name: 'Lisa', patient_last_name: 'Li', bill_date: '2024-01-21', description: 'Examination Fee', amount: 680.00, payment_method: 'Alipay', payment_status: 'Paid', notes: 'Comprehensive physical exam' },
                { bill_id: 3, patient_id: 3, patient_first_name: 'David', patient_last_name: 'Wang', bill_date: '2024-01-22', description: 'Treatment Fee', amount: 1200.00, payment_method: 'Insurance', payment_status: 'Pending', notes: 'Post-operative treatment fee' }
            ]
        };
    </script>
</head>
<body>
    <!-- API Error Alert (dynamic display) -->
    <div id="apiErrorAlert" class="alert alert-danger alert-dismissible fade show api-error-alert" style="display: none;">
        <button type="button" class="btn-close" onclick="hideApiError()"></button>
        <h6 class="alert-heading">‚ö†Ô∏è API Connection Error</h6>
        <p id="apiErrorMessage">Unable to connect to server</p>
        <hr>
        <p class="mb-1"><strong>Please check:</strong></p>
        <ol class="mb-0">
            <li>Is backend service running? (<code>python app.py</code>)</li>
            <li>Is backend URL correct? <code id="apiUrlDisplay">http://localhost:5000</code></li>
            <li>Check browser console (F12) for detailed error</li>
        </ol>
    </div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-4">
                    <h4 class="text-center">üë®‚Äçüíº Admin Center</h4>
                    <p class="text-center text-light">Super Admin</p>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="loadDashboard(); return false;">
                            üìä Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadPatients(); return false;">
                            üë• Patient Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadDoctors(); return false;">
                            üë®‚Äç‚öïÔ∏è Doctor Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadAppointments(); return false;">
                            üìÖ Appointment Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadBilling(); return false;">
                            üí∞ Financial Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadReports(); return false;">
                            üìà Reports & Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout(); return false;">
                            üö™ Logout
                        </a>
                    </li>
                </ul>                
            </div>
            
            <!-- Main Content Area -->
            <div class="col-md-9 col-lg-10 p-4">
                <!-- Page Title -->
                <h2 class="mb-4" id="page-title">System Dashboard</h2>
                
                <!-- Dashboard Content -->
                <div id="dashboard-content">
                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card stat-card stat-1">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Total Patients</h6>
                                            <h3 class="mb-0" id="total-patients">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <span class="display-6">üë•</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card stat-card stat-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Total Doctors</h6>
                                            <h3 class="mb-0" id="total-doctors">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <span class="display-6">üë®‚Äç‚öïÔ∏è</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card stat-card stat-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Today's Appointments</h6>
                                            <h3 class="mb-0" id="today-appointments">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <span class="display-6">üìÖ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card stat-card stat-4">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="text-muted">Monthly Revenue</h6>
                                            <h3 class="mb-0" id="month-revenue">¬•0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <span class="display-6">üí∞</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Search Dashboard -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="mb-0">Quick Search</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="globalSearch" placeholder="Search patients, doctors, appointments...">
                                                <button class="btn btn-primary" onclick="performGlobalSearch()">Search</button>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select" id="searchCategory">
                                                <option value="all">All Categories</option>
                                                <option value="patients">Patients</option>
                                                <option value="doctors">Doctors</option>
                                                <option value="appointments">Appointments</option>
                                                <option value="billing">Billing</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-end">
                                                <button class="btn btn-outline-primary me-2" onclick="openQuickPatientSearch()">
                                                    üîç Quick Patient Search
                                                </button>
                                                <button class="btn btn-outline-success" onclick="openQuickDoctorSearch()">
                                                    üîç Quick Doctor Search
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="row">
                        <div class="col-md-8 mb-4">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">System Overview</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>System Status</h6>
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span>API Connection</span>
                                                    <span id="api-status" class="badge bg-success api-status-badge">Normal</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span>Database Connection</span>
                                                    <span id="db-status" class="badge bg-success api-status-badge">Normal</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>System Uptime</span>
                                                    <span id="uptime">0 days</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Statistics</h6>
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span>New Patients Today</span>
                                                    <span id="today-new-patients">0</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span>Completed Appointments Today</span>
                                                    <span id="today-completed">0</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>Today's Income</span>
                                                    <span id="today-income">¬•0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="openPatientModal('add')">
                                            ‚ûï Add New Patient
                                        </button>
                                        <button class="btn btn-outline-success" onclick="openDoctorModal('add')">
                                            ‚ûï Add New Doctor
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="openAppointmentModal('add')">
                                            üìÖ Schedule Appointment
                                        </button>
                                        <button class="btn btn-outline-info" onclick="openBillModal('add')">
                                            üí∞ Create Bill
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Management Page -->
                <div id="patients-content" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Patient Management</h5>
                            <div>
                                <button class="btn btn-light btn-sm me-2" onclick="exportPatients()">üìÑ Export</button>
                                <button class="btn btn-light btn-sm" onclick="openPatientModal('add')">‚ûï Add Patient</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Patient Search Form -->
                            <div class="search-form">
                                <h6>Search Patients</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Patient ID</label>
                                        <input type="text" class="form-control" id="searchPatientId" placeholder="P001, P002, etc.">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Name</label>
                                        <input type="text" class="form-control" id="searchPatientName" placeholder="First or last name">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Gender</label>
                                        <select class="form-select" id="searchPatientGender">
                                            <option value="">All Genders</option>
                                            <option value="M">Male</option>
                                            <option value="F">Female</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Phone</label>
                                        <input type="text" class="form-control" id="searchPatientPhone" placeholder="Phone number">
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Age Range</label>
                                        <select class="form-select" id="searchPatientAge">
                                            <option value="">All Ages</option>
                                            <option value="0-18">0-18 years</option>
                                            <option value="19-35">19-35 years</option>
                                            <option value="36-60">36-60 years</option>
                                            <option value="61+">61+ years</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Insurance Provider</label>
                                        <input type="text" class="form-control" id="searchPatientInsurance" placeholder="Insurance company">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Registration Date</label>
                                        <input type="date" class="form-control" id="searchPatientRegDate">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary" onclick="searchPatients()">Search</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="advanced-search-toggle" onclick="toggleAdvancedPatientSearch()">
                                    üîç Advanced Search Options
                                </div>
                                <div id="advancedPatientSearch" style="display: none; margin-top: 15px;">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" id="searchPatientEmail" placeholder="Email address">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Address</label>
                                            <input type="text" class="form-control" id="searchPatientAddress" placeholder="Address contains">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Date of Birth</label>
                                            <input type="date" class="form-control" id="searchPatientDob">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Search Results Summary -->
                            <div class="quick-stats" id="patientSearchStats" style="display: none;">
                                Found <span id="patientCount">0</span> patients matching your criteria
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Patient ID</th>
                                            <th>Name</th>
                                            <th>Gender</th>
                                            <th>Age</th>
                                            <th>Phone</th>
                                            <th>Insurance</th>
                                            <th>Registration Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patients-table">
                                        <tr><td colspan="8">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav aria-label="Patient pagination" id="patientPagination" style="display: none;">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled" id="patientPrevPage">
                                        <a class="page-link" href="#" onclick="changePatientPage(-1)">Previous</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item disabled" id="patientNextPage">
                                        <a class="page-link" href="#" onclick="changePatientPage(1)">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- Doctor Management Page -->
                <div id="doctors-content" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Doctor Management</h5>
                            <div>
                                <button class="btn btn-light btn-sm me-2" onclick="exportDoctors()">üìÑ Export</button>
                                <button class="btn btn-light btn-sm" onclick="openDoctorModal('add')">‚ûï Add Doctor</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Doctor Search Form -->
                            <div class="search-form">
                                <h6>Search Doctors</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Doctor ID</label>
                                        <input type="text" class="form-control" id="searchDoctorId" placeholder="D001, D002, etc.">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Name</label>
                                        <input type="text" class="form-control" id="searchDoctorName" placeholder="First or last name">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Specialization</label>
                                        <select class="form-select" id="searchDoctorSpecialization">
                                            <option value="">All Specializations</option>
                                            <option value="General Practice">General Practice</option>
                                            <option value="Internal Medicine">Internal Medicine</option>
                                            <option value="Surgery">Surgery</option>
                                            <option value="Pediatrics">Pediatrics</option>
                                            <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                                            <option value="Ophthalmology">Ophthalmology</option>
                                            <option value="ENT">ENT</option>
                                            <option value="Dermatology">Dermatology</option>
                                            <option value="Dentistry">Dentistry</option>
                                            <option value="Psychology">Psychology</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Hospital Branch</label>
                                        <select class="form-select" id="searchDoctorBranch">
                                            <option value="">All Branches</option>
                                            <option value="Main Hospital">Main Hospital</option>
                                            <option value="Branch A">Branch A</option>
                                            <option value="Branch B">Branch B</option>
                                            <option value="Branch C">Branch C</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Experience (Years)</label>
                                        <select class="form-select" id="searchDoctorExperience">
                                            <option value="">Any Experience</option>
                                            <option value="0-5">0-5 years</option>
                                            <option value="6-10">6-10 years</option>
                                            <option value="11-20">11-20 years</option>
                                            <option value="21+">21+ years</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Phone</label>
                                        <input type="text" class="form-control" id="searchDoctorPhone" placeholder="Phone number">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="searchDoctorEmail" placeholder="Email address">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-success" onclick="searchDoctors()">Search</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Search Results Summary -->
                            <div class="quick-stats" id="doctorSearchStats" style="display: none;">
                                Found <span id="doctorCount">0</span> doctors matching your criteria
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Doctor ID</th>
                                            <th>Name</th>
                                            <th>Specialization</th>
                                            <th>Experience (Years)</th>
                                            <th>Phone</th>
                                            <th>Hospital Branch</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="doctors-table">
                                        <tr><td colspan="7">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Appointment Management Page -->
                <div id="appointments-content" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Appointment Management</h5>
                            <div>
                                <button class="btn btn-light btn-sm me-2" onclick="exportAppointments()">üìÑ Export</button>
                                <button class="btn btn-light btn-sm" onclick="openAppointmentModal('add')">üìÖ New Appointment</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Appointment Search Form -->
                            <div class="search-form">
                                <h6>Search Appointments</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Appointment ID</label>
                                        <input type="text" class="form-control" id="searchAppointmentId" placeholder="A001, A002, etc.">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Patient Name</label>
                                        <input type="text" class="form-control" id="searchAppointmentPatient" placeholder="Patient name">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Doctor Name</label>
                                        <input type="text" class="form-control" id="searchAppointmentDoctor" placeholder="Doctor name">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" id="searchAppointmentStatus">
                                            <option value="">All Status</option>
                                            <option value="Scheduled">Scheduled</option>
                                            <option value="Confirmed">Confirmed</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Date Range (From)</label>
                                        <input type="date" class="form-control" id="searchAppointmentDateFrom">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Date Range (To)</label>
                                        <input type="date" class="form-control" id="searchAppointmentDateTo">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Time Slot</label>
                                        <select class="form-select" id="searchAppointmentTime">
                                            <option value="">Any Time</option>
                                            <option value="morning">Morning (08:00-12:00)</option>
                                            <option value="afternoon">Afternoon (13:00-17:00)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-warning" onclick="searchAppointments()">Search</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="advanced-search-toggle" onclick="toggleAdvancedAppointmentSearch()">
                                    üîç Advanced Search Options
                                </div>
                                <div id="advancedAppointmentSearch" style="display: none; margin-top: 15px;">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Reason for Visit</label>
                                            <select class="form-select" id="searchAppointmentReason">
                                                <option value="">All Reasons</option>
                                                <option value="Regular Checkup">Regular Checkup</option>
                                                <option value="Follow-up">Follow-up</option>
                                                <option value="Treatment">Treatment</option>
                                                <option value="Consultation">Consultation</option>
                                                <option value="Physical Exam">Physical Exam</option>
                                                <option value="Surgery">Surgery</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Patient ID</label>
                                            <input type="text" class="form-control" id="searchAppointmentPatientId" placeholder="Patient ID">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Doctor ID</label>
                                            <input type="text" class="form-control" id="searchAppointmentDoctorId" placeholder="Doctor ID">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Search Results Summary -->
                            <div class="quick-stats" id="appointmentSearchStats" style="display: none;">
                                Found <span id="appointmentCount">0</span> appointments matching your criteria
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Appointment ID</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Patient</th>
                                            <th>Doctor</th>
                                            <th>Reason</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="appointments-table">
                                        <tr><td colspan="8">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Management Page -->
                <div id="billing-content" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Financial Management</h5>
                            <div>
                                <button class="btn btn-light btn-sm me-2" onclick="exportBills()">üìÑ Export</button>
                                <button class="btn btn-light btn-sm" onclick="openBillModal('add')">üí∞ Create Bill</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted">Total Income</h6>
                                            <h3 class="text-success" id="total-income">¬•0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted">Monthly Income</h6>
                                            <h3 class="text-primary" id="month-income">¬•0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted">Pending Payments</h6>
                                            <h3 class="text-warning" id="pending-income">¬•0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted">Average Bill</h6>
                                            <h3 class="text-info" id="avg-bill">¬•0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Billing Search Form -->
                            <div class="search-form">
                                <h6>Search Bills</h6>
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Bill ID</label>
                                        <input type="text" class="form-control" id="searchBillId" placeholder="B001, B002, etc.">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Patient Name</label>
                                        <input type="text" class="form-control" id="searchBillPatient" placeholder="Patient name">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" id="searchBillStatus">
                                            <option value="">All Status</option>
                                            <option value="Paid">Paid</option>
                                            <option value="Pending">Pending</option>
                                            <option value="Cancelled">Cancelled</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-select" id="searchBillPaymentMethod">
                                            <option value="">All Methods</option>
                                            <option value="Cash">Cash</option>
                                            <option value="Bank Card">Bank Card</option>
                                            <option value="Alipay">Alipay</option>
                                            <option value="WeChat Pay">WeChat Pay</option>
                                            <option value="Insurance">Insurance</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Date Range (From)</label>
                                        <input type="date" class="form-control" id="searchBillDateFrom">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Date Range (To)</label>
                                        <input type="date" class="form-control" id="searchBillDateTo">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Amount Range</label>
                                        <select class="form-select" id="searchBillAmount">
                                            <option value="">Any Amount</option>
                                            <option value="0-500">¬•0 - ¬•500</option>
                                            <option value="500-1000">¬•500 - ¬•1,000</option>
                                            <option value="1000-5000">¬•1,000 - ¬•5,000</option>
                                            <option value="5000+">¬•5,000+</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-danger" onclick="searchBills()">Search</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Search Results Summary -->
                            <div class="quick-stats" id="billSearchStats" style="display: none;">
                                Found <span id="billCount">0</span> bills matching your criteria. Total amount: ¬•<span id="billTotalAmount">0</span>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Bill ID</th>
                                            <th>Date</th>
                                            <th>Patient</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Payment Method</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billing-table">
                                        <tr><td colspan="8">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports & Analytics Page -->
                <div id="reports-content" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Reports & Analytics</h5>
                            <div>
                                <button class="btn btn-light btn-sm me-2" onclick="generateMonthlyReport()">üìä Monthly Report</button>
                                <button class="btn btn-light btn-sm" onclick="exportAllData()">üì• Export All Data</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Date Range Analysis</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Start Date</label>
                                                    <input type="date" class="form-control" id="reportStartDate">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">End Date</label>
                                                    <input type="date" class="form-control" id="reportEndDate">
                                                </div>
                                                <div class="col-md-12">
                                                    <button class="btn btn-info w-100" onclick="generateDateRangeReport()">
                                                        üìà Generate Report
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Quick Reports</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-primary" onclick="generatePatientDemographics()">
                                                    üë• Patient Demographics
                                                </button>
                                                <button class="btn btn-outline-success" onclick="generateDoctorPerformance()">
                                                    üë®‚Äç‚öïÔ∏è Doctor Performance
                                                </button>
                                                <button class="btn btn-outline-warning" onclick="generateAppointmentAnalysis()">
                                                    üìÖ Appointment Analysis
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="generateFinancialSummary()">
                                                    üí∞ Financial Summary
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Report Results -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Report Results</h6>
                                </div>
                                <div class="card-body">
                                    <div id="reportResults">
                                        <p class="text-center text-muted">Select a report to generate results</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Search Modals -->
    <!-- Quick Patient Search Modal -->
    <div class="modal fade" id="quickPatientSearchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Patient Search</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="quickPatientSearch" placeholder="Search by ID, name, phone, or insurance">
                        <button class="btn btn-primary" onclick="performQuickPatientSearch()">Search</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Insurance</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="quickPatientResults">
                                <tr><td colspan="5">Enter search terms to find patients</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Doctor Search Modal -->
    <div class="modal fade" id="quickDoctorSearchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Doctor Search</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="quickDoctorSearch" placeholder="Search by ID, name, specialization, or branch">
                        <button class="btn btn-success" onclick="performQuickDoctorSearch()">Search</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Specialization</th>
                                    <th>Branch</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="quickDoctorResults">
                                <tr><td colspan="5">Enter search terms to find doctors</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Patient Modal -->
    <div class="modal fade" id="patientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patientModalTitle">Add New Patient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="patientForm">
                        <input type="hidden" id="patientId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-control" id="patientFirstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-control" id="patientLastName" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Gender</label>
                                <select class="form-select" id="patientGender">
                                    <option value="">Select</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" id="patientDob">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" class="form-control" id="patientPhone" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="patientEmail">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="patientAddress" rows="2"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Insurance Provider</label>
                                <input type="text" class="form-control" id="patientInsuranceProvider">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Insurance Number</label>
                                <input type="text" class="form-control" id="patientInsuranceNumber">
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Doctor Modal -->
    <div class="modal fade" id="doctorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="doctorModalTitle">Add New Doctor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="doctorForm">
                        <input type="hidden" id="doctorId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-control" id="doctorFirstName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-control" id="doctorLastName" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Specialization *</label>
                            <select class="form-select" id="doctorSpecialization" required>
                                <option value="">Select Department</option>
                                <option value="General Practice">General Practice</option>
                                <option value="Internal Medicine">Internal Medicine</option>
                                <option value="Surgery">Surgery</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                                <option value="Ophthalmology">Ophthalmology</option>
                                <option value="ENT">ENT</option>
                                <option value="Dermatology">Dermatology</option>
                                <option value="Dentistry">Dentistry</option>
                                <option value="Psychology">Psychology</option>
                                <option value="Rehabilitation">Rehabilitation</option>
                                <option value="Emergency">Emergency</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" id="doctorPhone" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="doctorEmail">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Experience (Years)</label>
                                <input type="number" class="form-control" id="doctorExperience" min="0" max="50">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hospital Branch *</label>
                                <select class="form-select" id="doctorBranch" required>
                                    <option value="">Select Branch</option>
                                    <option value="Main Hospital">Main Hospital</option>
                                    <option value="Branch A">Branch A</option>
                                    <option value="Branch B">Branch B</option>
                                    <option value="Branch C">Branch C</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Bio/Notes</label>
                            <textarea class="form-control" id="doctorBio" rows="3" placeholder="Doctor's professional background, expertise, etc."></textarea>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Appointment Modal -->
    <div class="modal fade" id="appointmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="appointmentModalTitle">Schedule New Appointment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="appointmentForm">
                        <input type="hidden" id="appointmentId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Patient *</label>
                                <select class="form-select" id="appointmentPatient" required>
                                    <option value="">Select Patient</option>
                                    <!-- Patient options will be dynamically loaded via JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Doctor *</label>
                                <select class="form-select" id="appointmentDoctor" required>
                                    <option value="">Select Doctor</option>
                                    <!-- Doctor options will be dynamically loaded via JavaScript -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Appointment Date *</label>
                                <input type="date" class="form-control" id="appointmentDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Appointment Time *</label>
                                <select class="form-select" id="appointmentTime" required>
                                    <option value="">Select Time</option>
                                    <option value="08:00">08:00</option>
                                    <option value="08:30">08:30</option>
                                    <option value="09:00">09:00</option>
                                    <option value="09:30">09:30</option>
                                    <option value="10:00">10:00</option>
                                    <option value="10:30">10:30</option>
                                    <option value="11:00">11:00</option>
                                    <option value="11:30">11:30</option>
                                    <option value="13:00">13:00</option>
                                    <option value="13:30">13:30</option>
                                    <option value="14:00">14:00</option>
                                    <option value="14:30">14:30</option>
                                    <option value="15:00">15:00</option>
                                    <option value="15:30">15:30</option>
                                    <option value="16:00">16:00</option>
                                    <option value="16:30">16:30</option>
                                    <option value="17:00">17:00</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Reason for Visit *</label>
                            <select class="form-select" id="appointmentReason" required>
                                <option value="">Select Reason</option>
                                <option value="Regular Checkup">Regular Checkup</option>
                                <option value="Follow-up">Follow-up</option>
                                <option value="Treatment">Treatment</option>
                                <option value="Consultation">Consultation</option>
                                <option value="Physical Exam">Physical Exam</option>
                                <option value="Surgery">Surgery</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Detailed Description</label>
                            <textarea class="form-control" id="appointmentDescription" rows="3" placeholder="Describe patient symptoms or special notes"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Status *</label>
                            <select class="form-select" id="appointmentStatus" required>
                                <option value="Scheduled">Scheduled</option>
                                <option value="Confirmed">Confirmed</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Bill Modal -->
    <div class="modal fade" id="billModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="billModalTitle">Create Bill</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="billForm">
                        <input type="hidden" id="billId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Patient *</label>
                                <select class="form-select" id="billPatient" required>
                                    <option value="">Select Patient</option>
                                    <!-- Patient options will be dynamically loaded via JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Bill Date *</label>
                                <input type="date" class="form-control" id="billDate" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Bill Description *</label>
                            <input type="text" class="form-control" id="billDescription" placeholder="e.g., Consultation fee, Medicine, Examination fee" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Amount *</label>
                                <input type="number" class="form-control" id="billAmount" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" id="billPaymentMethod">
                                    <option value="">Select</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Bank Card">Bank Card</option>
                                    <option value="Alipay">Alipay</option>
                                    <option value="WeChat Pay">WeChat Pay</option>
                                    <option value="Insurance">Insurance</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Status *</label>
                            <select class="form-select" id="billStatus" required>
                                <option value="Pending">Pending</option>
                                <option value="Paid">Paid</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="billNotes" rows="3" placeholder="Additional notes for the bill"></textarea>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ================ Global Functions and Configuration ================
        
        // Global variables for search
        let currentPatientPage = 1;
        const patientsPerPage = 10;
        
        // Show API error
        function showApiError(message) {
            document.getElementById('apiErrorMessage').textContent = message;
            document.getElementById('apiUrlDisplay').textContent = API_CONFIG.BASE_URL;
            document.getElementById('apiErrorAlert').style.display = 'block';
        }
        
        // Hide API error
        function hideApiError() {
            document.getElementById('apiErrorAlert').style.display = 'none';
        }
        
        // Universal API request function - automatically adds /admin/ prefix
        async function apiRequest(endpoint, options = {}) {
            // Automatically add /admin/ prefix
            if (!endpoint.startsWith('/admin/')) {
                endpoint = '/admin' + (endpoint.startsWith('/') ? '' : '/') + endpoint;
            }
            
            const url = `${API_CONFIG.BASE_URL}${endpoint}`;
            
            // If mock mode is enabled, return mock data
            if (API_CONFIG.MOCK_MODE) {
                await new Promise(resolve => setTimeout(resolve, 300)); // Simulate network delay
                
                if (endpoint.includes('/admin/patients/')) {
                    const id = endpoint.split('/').pop();
                    return MOCK_DATA.patients.find(p => p.patient_id == id) || null;
                } else if (endpoint.includes('/admin/doctors/')) {
                    const id = endpoint.split('/').pop();
                    return MOCK_DATA.doctors.find(d => d.doctor_id == id) || null;
                } else if (endpoint.includes('/admin/appointments/')) {
                    const id = endpoint.split('/').pop();
                    return MOCK_DATA.appointments.find(a => a.appointment_id == id) || null;
                } else if (endpoint.includes('/admin/billing/')) {
                    const id = endpoint.split('/').pop();
                    return MOCK_DATA.billing.find(b => b.bill_id == id) || null;
                } else if (endpoint === '/admin/patients') {
                    return MOCK_DATA.patients;
                } else if (endpoint === '/admin/doctors') {
                    return MOCK_DATA.doctors;
                } else if (endpoint === '/admin/appointments') {
                    return MOCK_DATA.appointments;
                } else if (endpoint === '/admin/billing') {
                    return MOCK_DATA.billing;
                }
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT);
                
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API request failed (${url}):`, error);
                
                // Show error alert
                if (error.name === 'AbortError') {
                    showApiError(`Request timeout (${API_CONFIG.TIMEOUT/1000} seconds)`);
                } else {
                    showApiError(`Unable to connect to server: ${error.message}`);
                }
                
                throw error;
            }
        }
        
        // Parallel API requests
        async function parallelApiRequests(requests) {
            try {
                const results = await Promise.allSettled(
                    requests.map(req => apiRequest(req.endpoint, req.options))
                );
                
                return results.map((result, index) => {
                    if (result.status === 'fulfilled') {
                        return result.value;
                    } else {
                        console.error(`Request ${requests[index].endpoint} failed:`, result.reason);
                        return null;
                    }
                });
            } catch (error) {
                console.error('Parallel requests failed:', error);
                return requests.map(() => null);
            }
        }
        
        // ================ Page Switching Functions ================
        
        function loadDashboard() {
            document.getElementById('page-title').textContent = 'System Dashboard';
            
            // Show/hide content areas
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('patients-content').style.display = 'none';
            document.getElementById('doctors-content').style.display = 'none';
            document.getElementById('appointments-content').style.display = 'none';
            document.getElementById('billing-content').style.display = 'none';
            document.getElementById('reports-content').style.display = 'none';
            
            // Update navigation active state
            updateNavActive('dashboard');
            
            // Load dashboard data
            loadDashboardData();
        }
        
        function loadPatients() {
            document.getElementById('page-title').textContent = 'Patient Management';
            
            // Show/hide content areas
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('patients-content').style.display = 'block';
            document.getElementById('doctors-content').style.display = 'none';
            document.getElementById('appointments-content').style.display = 'none';
            document.getElementById('billing-content').style.display = 'none';
            document.getElementById('reports-content').style.display = 'none';
            
            // Update navigation active state
            updateNavActive('patients');
            
            // Load patient data
            loadPatientsData();
        }
        
        function loadDoctors() {
            document.getElementById('page-title').textContent = 'Doctor Management';
            
            // Show/hide content areas
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('patients-content').style.display = 'none';
            document.getElementById('doctors-content').style.display = 'block';
            document.getElementById('appointments-content').style.display = 'none';
            document.getElementById('billing-content').style.display = 'none';
            document.getElementById('reports-content').style.display = 'none';
            
            // Update navigation active state
            updateNavActive('doctors');
            
            // Load doctor data
            loadDoctorsData();
        }
        
        function loadAppointments() {
            document.getElementById('page-title').textContent = 'Appointment Management';
            
            // Show/hide content areas
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('patients-content').style.display = 'none';
            document.getElementById('doctors-content').style.display = 'none';
            document.getElementById('appointments-content').style.display = 'block';
            document.getElementById('billing-content').style.display = 'none';
            document.getElementById('reports-content').style.display = 'none';
            
            // Update navigation active state
            updateNavActive('appointments');
            
            // Load appointment data
            loadAppointmentsData();
        }
        
        function loadBilling() {
            document.getElementById('page-title').textContent = 'Financial Management';
            
            // Show/hide content areas
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('patients-content').style.display = 'none';
            document.getElementById('doctors-content').style.display = 'none';
            document.getElementById('appointments-content').style.display = 'none';
            document.getElementById('billing-content').style.display = 'block';
            document.getElementById('reports-content').style.display = 'none';
            
            // Update navigation active state
            updateNavActive('billing');
            
            // Load financial data
            loadBillingData();
        }
        
        function loadReports() {
            document.getElementById('page-title').textContent = 'Reports & Analytics';
            
            // Show/hide content areas
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('patients-content').style.display = 'none';
            document.getElementById('doctors-content').style.display = 'none';
            document.getElementById('appointments-content').style.display = 'none';
            document.getElementById('billing-content').style.display = 'none';
            document.getElementById('reports-content').style.display = 'block';
            
            // Update navigation active state
            updateNavActive('reports');
            
            // Load reports data
            initializeReports();
        }
        
        function updateNavActive(page) {
            // Remove all active classes
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Activate corresponding navigation based on page parameter
            const navLinks = document.querySelectorAll('.nav-link');
            if (page === 'dashboard') {
                navLinks[0].classList.add('active');
            } else if (page === 'patients') {
                navLinks[1].classList.add('active');
            } else if (page === 'doctors') {
                navLinks[2].classList.add('active');
            } else if (page === 'appointments') {
                navLinks[3].classList.add('active');
            } else if (page === 'billing') {
                navLinks[4].classList.add('active');
            } else if (page === 'reports') {
                navLinks[5].classList.add('active');
            }
        }
        
        // ================ Dashboard Functions ================
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Parallel requests for all data - use /admin/ prefix
                const [patients, doctors, appointments, bills] = await parallelApiRequests([
                    { endpoint: '/patients' }, // Will become /admin/patients
                    { endpoint: '/doctors' },   // Will become /admin/doctors
                    { endpoint: '/appointments' }, // Will become /admin/appointments
                    { endpoint: '/billing' }    // Will become /admin/billing
                ]);
                
                // Update statistics cards
                if (patients) {
                    document.getElementById('total-patients').textContent = patients.length || 0;
                } else {
                    document.getElementById('total-patients').textContent = '--';
                }
                
                if (doctors) {
                    document.getElementById('total-doctors').textContent = doctors.length || 0;
                } else {
                    document.getElementById('total-doctors').textContent = '--';
                }
                
                if (appointments) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayAppointments = appointments.filter(a => a.appointment_date === today);
                    document.getElementById('today-appointments').textContent = todayAppointments.length || 0;
                } else {
                    document.getElementById('today-appointments').textContent = '--';
                }
                
                if (bills) {
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    
                    const monthBills = bills.filter(bill => {
                        if (!bill.bill_date) return false;
                        const billDate = new Date(bill.bill_date);
                        return billDate.getMonth() + 1 === currentMonth && 
                               billDate.getFullYear() === currentYear &&
                               bill.payment_status === 'Paid';
                    });
                    
                    const monthRevenue = monthBills.reduce((sum, bill) => sum + (bill.amount || 0), 0);
                    document.getElementById('month-revenue').textContent = `¬•${monthRevenue.toLocaleString()}`;
                } else {
                    document.getElementById('month-revenue').textContent = '¬•0';
                }
                
                // Update system overview
                if (patients && appointments && bills) {
                    updateSystemOverview(patients, appointments, bills);
                }
                
                // Update API status
                document.getElementById('api-status').className = 'badge bg-success api-status-badge';
                document.getElementById('api-status').textContent = 'Normal';
                document.getElementById('db-status').className = 'badge bg-success api-status-badge';
                document.getElementById('db-status').textContent = 'Normal';
                
                // Hide error alert
                hideApiError();
                
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                
                // Show error status
                document.getElementById('api-status').className = 'badge bg-danger api-status-badge';
                document.getElementById('api-status').textContent = 'Abnormal';
                document.getElementById('db-status').className = 'badge bg-danger api-status-badge';
                document.getElementById('db-status').textContent = 'Abnormal';
                
                // Show mock data (if enabled)
                if (API_CONFIG.MOCK_MODE) {
                    document.getElementById('total-patients').textContent = MOCK_DATA.patients.length;
                    document.getElementById('total-doctors').textContent = MOCK_DATA.doctors.length;
                    
                    const today = new Date().toISOString().split('T')[0];
                    const todayAppointments = MOCK_DATA.appointments.filter(a => a.appointment_date === today);
                    document.getElementById('today-appointments').textContent = todayAppointments.length;
                    
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    
                    const monthBills = MOCK_DATA.billing.filter(bill => {
                        if (!bill.bill_date) return false;
                        const billDate = new Date(bill.bill_date);
                        return billDate.getMonth() + 1 === currentMonth && 
                               billDate.getFullYear() === currentYear &&
                               bill.payment_status === 'Paid';
                    });
                    
                    const monthRevenue = monthBills.reduce((sum, bill) => sum + (bill.amount || 0), 0);
                    document.getElementById('month-revenue').textContent = `¬•${monthRevenue.toLocaleString()}`;
                    
                    updateSystemOverview(MOCK_DATA.patients, MOCK_DATA.appointments, MOCK_DATA.billing);
                }
            }
        }
        
        // Update system overview
        function updateSystemOverview(patients, appointments, bills) {
            const today = new Date().toISOString().split('T')[0];
            
            // New patients today
            const todayNewPatients = patients.filter(patient => {
                if (!patient.registration_date) return false;
                return patient.registration_date === today;
            }).length;
            document.getElementById('today-new-patients').textContent = todayNewPatients;
            
            // Completed appointments today
            const todayCompleted = appointments.filter(appointment => {
                return appointment.appointment_date === today && appointment.status === 'Completed';
            }).length;
            document.getElementById('today-completed').textContent = todayCompleted;
            
            // Today's income
            const todayBills = bills.filter(bill => {
                return bill.bill_date === today && bill.payment_status === 'Paid';
            });
            const todayIncome = todayBills.reduce((sum, bill) => sum + (bill.amount || 0), 0);
            document.getElementById('today-income').textContent = `¬•${todayIncome.toLocaleString()}`;
            
            // System uptime (simulated)
            const startTime = new Date('2024-01-01');
            const todayDate = new Date();
            const diffTime = Math.abs(todayDate - startTime);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            document.getElementById('uptime').textContent = `${diffDays} days`;
        }
        
        // ================ Patient Management with Search ================
        
        // Load patient data with search functionality
        async function loadPatientsData() {
            try {
                // Use /admin/ prefix
                const patients = await apiRequest('/patients');
                
                window.allPatients = patients; // Store for searching
                currentPatientPage = 1;
                
                if (!patients || patients.length === 0) {
                    document.getElementById('patients-table').innerHTML = 
                        '<tr><td colspan="8" class="text-center">No patient data available</td></tr>';
                    document.getElementById('patientSearchStats').style.display = 'none';
                    document.getElementById('patientPagination').style.display = 'none';
                    return;
                }
                
                displayPatients(patients.slice(0, patientsPerPage));
                updatePatientPagination(patients.length);
                showPatientSearchStats(patients.length);
                
            } catch (error) {
                console.error('Failed to load patient data:', error);
                document.getElementById('patients-table').innerHTML = 
                    '<tr><td colspan="8" class="text-danger">Failed to load, check API connection</td></tr>';
            }
        }
        
        // Display patients with pagination
        function displayPatients(patients) {
            if (patients.length === 0) {
                document.getElementById('patients-table').innerHTML = 
                    '<tr><td colspan="8" class="text-center">No patients found</td></tr>';
                return;
            }
            
            let html = '';
            patients.forEach(patient => {
                // Calculate age
                let age = '--';
                if (patient.date_of_birth) {
                    const birthDate = new Date(patient.date_of_birth);
                    const today = new Date();
                    age = today.getFullYear() - birthDate.getFullYear();
                }
                
                html += `
                    <tr>
                        <td>P${patient.patient_id}</td>
                        <td>${patient.first_name || ''} ${patient.last_name || ''}</td>
                        <td>${patient.gender === 'M' ? 'Male' : patient.gender === 'F' ? 'Female' : 'Unknown'}</td>
                        <td>${age}</td>
                        <td>${patient.contact_number || '--'}</td>
                        <td>${patient.insurance_provider || '--'}</td>
                        <td>${patient.registration_date || '--'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPatient(${patient.patient_id})">View</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editPatient(${patient.patient_id})">Edit</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePatient(${patient.patient_id})">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('patients-table').innerHTML = html;
        }
        
        // Update patient pagination
        function updatePatientPagination(totalPatients) {
            const totalPages = Math.ceil(totalPatients / patientsPerPage);
            const pagination = document.getElementById('patientPagination');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'block';
            let paginationHtml = '';
            
            // Previous button
            if (currentPatientPage > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePatientPage(${currentPatientPage - 1})">Previous</a>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item disabled">
                        <a class="page-link" href="#">Previous</a>
                    </li>
                `;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPatientPage) {
                    paginationHtml += `
                        <li class="page-item active">
                            <a class="page-link" href="#" onclick="changePatientPage(${i})">${i}</a>
                        </li>
                    `;
                } else {
                    paginationHtml += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePatientPage(${i})">${i}</a>
                        </li>
                    `;
                }
            }
            
            // Next button
            if (currentPatientPage < totalPages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePatientPage(${currentPatientPage + 1})">Next</a>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item disabled">
                        <a class="page-link" href="#">Next</a>
                    </li>
                `;
            }
            
            document.querySelector('#patientPagination .pagination').innerHTML = paginationHtml;
        }
        
        // Change patient page
        function changePatientPage(page) {
            currentPatientPage = page;
            const filteredPatients = window.filteredPatients || window.allPatients;
            const startIndex = (page - 1) * patientsPerPage;
            const endIndex = startIndex + patientsPerPage;
            displayPatients(filteredPatients.slice(startIndex, endIndex));
            updatePatientPagination(filteredPatients.length);
        }
        
        // Show patient search stats
        function showPatientSearchStats(count) {
            document.getElementById('patientSearchStats').style.display = 'block';
            document.getElementById('patientCount').textContent = count;
        }
        
        // Toggle advanced patient search
        function toggleAdvancedPatientSearch() {
            const advancedSearch = document.getElementById('advancedPatientSearch');
            if (advancedSearch.style.display === 'none') {
                advancedSearch.style.display = 'block';
            } else {
                advancedSearch.style.display = 'none';
            }
        }
        
        // Search patients
        function searchPatients() {
            const patientId = document.getElementById('searchPatientId').value.replace(/\D/g, '');
            const name = document.getElementById('searchPatientName').value.toLowerCase();
            const gender = document.getElementById('searchPatientGender').value;
            const phone = document.getElementById('searchPatientPhone').value;
            const ageRange = document.getElementById('searchPatientAge').value;
            const insurance = document.getElementById('searchPatientInsurance').value.toLowerCase();
            const regDate = document.getElementById('searchPatientRegDate').value;
            const email = document.getElementById('searchPatientEmail').value.toLowerCase();
            const address = document.getElementById('searchPatientAddress').value.toLowerCase();
            const dob = document.getElementById('searchPatientDob').value;
            
            let filteredPatients = window.allPatients || [];
            
            // Apply filters
            if (patientId) {
                filteredPatients = filteredPatients.filter(p => 
                    p.patient_id.toString().includes(patientId)
                );
            }
            
            if (name) {
                filteredPatients = filteredPatients.filter(p => {
                    const fullName = `${p.first_name || ''} ${p.last_name || ''}`.toLowerCase();
                    return fullName.includes(name) || 
                           (p.first_name && p.first_name.toLowerCase().includes(name)) ||
                           (p.last_name && p.last_name.toLowerCase().includes(name));
                });
            }
            
            if (gender) {
                filteredPatients = filteredPatients.filter(p => p.gender === gender);
            }
            
            if (phone) {
                filteredPatients = filteredPatients.filter(p => 
                    p.contact_number && p.contact_number.includes(phone)
                );
            }
            
            if (ageRange) {
                const [minAge, maxAge] = ageRange === '61+' ? [61, 150] : ageRange.split('-').map(Number);
                filteredPatients = filteredPatients.filter(p => {
                    if (!p.date_of_birth) return false;
                    
                    const birthDate = new Date(p.date_of_birth);
                    const today = new Date();
                    const age = today.getFullYear() - birthDate.getFullYear();
                    
                    return age >= minAge && age <= maxAge;
                });
            }
            
            if (insurance) {
                filteredPatients = filteredPatients.filter(p => 
                    p.insurance_provider && p.insurance_provider.toLowerCase().includes(insurance)
                );
            }
            
            if (regDate) {
                filteredPatients = filteredPatients.filter(p => p.registration_date === regDate);
            }
            
            if (email) {
                filteredPatients = filteredPatients.filter(p => 
                    p.email && p.email.toLowerCase().includes(email)
                );
            }
            
            if (address) {
                filteredPatients = filteredPatients.filter(p => 
                    p.address && p.address.toLowerCase().includes(address)
                );
            }
            
            if (dob) {
                filteredPatients = filteredPatients.filter(p => p.date_of_birth === dob);
            }
            
            window.filteredPatients = filteredPatients;
            currentPatientPage = 1;
            
            displayPatients(filteredPatients.slice(0, patientsPerPage));
            updatePatientPagination(filteredPatients.length);
            showPatientSearchStats(filteredPatients.length);
        }
        
        // Export patients
        function exportPatients() {
            const patients = window.filteredPatients || window.allPatients || [];
            let csvContent = "data:text/csv;charset=utf-8,Patient ID,First Name,Last Name,Gender,Date of Birth,Age,Phone,Email,Address,Insurance Provider,Insurance Number,Registration Date\n";
            
            patients.forEach(patient => {
                // Calculate age
                let age = '--';
                if (patient.date_of_birth) {
                    const birthDate = new Date(patient.date_of_birth);
                    const today = new Date();
                    age = today.getFullYear() - birthDate.getFullYear();
                }
                
                const row = [
                    `P${patient.patient_id}`,
                    patient.first_name || '',
                    patient.last_name || '',
                    patient.gender === 'M' ? 'Male' : patient.gender === 'F' ? 'Female' : 'Unknown',
                    patient.date_of_birth || '',
                    age,
                    patient.contact_number || '',
                    patient.email || '',
                    patient.address || '',
                    patient.insurance_provider || '',
                    patient.insurance_number || '',
                    patient.registration_date || ''
                ].map(field => `"${field}"`).join(",");
                
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `patients_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ================ Doctor Management with Search ================
        
        // Load doctor data with search functionality
        async function loadDoctorsData() {
            try {
                // Use /admin/ prefix
                const doctors = await apiRequest('/doctors');
                
                window.allDoctors = doctors; // Store for searching
                
                if (!doctors || doctors.length === 0) {
                    document.getElementById('doctors-table').innerHTML = 
                        '<tr><td colspan="7" class="text-center">No doctor data available</td></tr>';
                    document.getElementById('doctorSearchStats').style.display = 'none';
                    return;
                }
                
                displayDoctors(doctors);
                showDoctorSearchStats(doctors.length);
                
            } catch (error) {
                console.error('Failed to load doctor data:', error);
                document.getElementById('doctors-table').innerHTML = 
                    '<tr><td colspan="7" class="text-danger">Failed to load, check API connection</td></tr>';
            }
        }
        
        // Display doctors
        function displayDoctors(doctors) {
            if (doctors.length === 0) {
                document.getElementById('doctors-table').innerHTML = 
                    '<tr><td colspan="7" class="text-center">No doctors found</td></tr>';
                return;
            }
            
            let html = '';
            doctors.forEach(doctor => {
                html += `
                    <tr>
                        <td>D${doctor.doctor_id}</td>
                        <td>Dr. ${doctor.first_name || ''} ${doctor.last_name || ''}</td>
                        <td>${doctor.specialization || '--'}</td>
                        <td>${doctor.years_experience || 0} years</td>
                        <td>${doctor.phone_number || '--'}</td>
                        <td>${doctor.hospital_branch || 'Main Hospital'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDoctor(${doctor.doctor_id})">View</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editDoctor(${doctor.doctor_id})">Edit</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor(${doctor.doctor_id})">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('doctors-table').innerHTML = html;
        }
        
        // Show doctor search stats
        function showDoctorSearchStats(count) {
            document.getElementById('doctorSearchStats').style.display = 'block';
            document.getElementById('doctorCount').textContent = count;
        }
        
        // Search doctors
        function searchDoctors() {
            const doctorId = document.getElementById('searchDoctorId').value.replace(/\D/g, '');
            const name = document.getElementById('searchDoctorName').value.toLowerCase();
            const specialization = document.getElementById('searchDoctorSpecialization').value;
            const branch = document.getElementById('searchDoctorBranch').value;
            const experience = document.getElementById('searchDoctorExperience').value;
            const phone = document.getElementById('searchDoctorPhone').value;
            const email = document.getElementById('searchDoctorEmail').value.toLowerCase();
            
            let filteredDoctors = window.allDoctors || [];
            
            // Apply filters
            if (doctorId) {
                filteredDoctors = filteredDoctors.filter(d => 
                    d.doctor_id.toString().includes(doctorId)
                );
            }
            
            if (name) {
                filteredDoctors = filteredDoctors.filter(d => {
                    const fullName = `${d.first_name || ''} ${d.last_name || ''}`.toLowerCase();
                    return fullName.includes(name) || 
                           (d.first_name && d.first_name.toLowerCase().includes(name)) ||
                           (d.last_name && d.last_name.toLowerCase().includes(name));
                });
            }
            
            if (specialization) {
                filteredDoctors = filteredDoctors.filter(d => d.specialization === specialization);
            }
            
            if (branch) {
                filteredDoctors = filteredDoctors.filter(d => d.hospital_branch === branch);
            }
            
            if (experience) {
                const [minExp, maxExp] = experience === '21+' ? [21, 100] : experience.split('-').map(Number);
                filteredDoctors = filteredDoctors.filter(d => {
                    const exp = d.years_experience || 0;
                    return exp >= minExp && exp <= maxExp;
                });
            }
            
            if (phone) {
                filteredDoctors = filteredDoctors.filter(d => 
                    d.phone_number && d.phone_number.includes(phone)
                );
            }
            
            if (email) {
                filteredDoctors = filteredDoctors.filter(d => 
                    d.email && d.email.toLowerCase().includes(email)
                );
            }
            
            window.filteredDoctors = filteredDoctors;
            displayDoctors(filteredDoctors);
            showDoctorSearchStats(filteredDoctors.length);
        }
        
        // Export doctors
        function exportDoctors() {
            const doctors = window.filteredDoctors || window.allDoctors || [];
            let csvContent = "data:text/csv;charset=utf-8,Doctor ID,First Name,Last Name,Specialization,Experience (Years),Phone,Email,Hospital Branch,Bio\n";
            
            doctors.forEach(doctor => {
                const row = [
                    `D${doctor.doctor_id}`,
                    doctor.first_name || '',
                    doctor.last_name || '',
                    doctor.specialization || '',
                    doctor.years_experience || 0,
                    doctor.phone_number || '',
                    doctor.email || '',
                    doctor.hospital_branch || '',
                    doctor.bio || ''
                ].map(field => `"${field}"`).join(",");
                
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `doctors_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ================ Appointment Management with Search ================
        
        // Load appointment data with search functionality
        async function loadAppointmentsData() {
            try {
                // Use /admin/ prefix
                const appointments = await apiRequest('/appointments');
                
                window.allAppointments = appointments; // Store for searching
                
                if (!appointments || appointments.length === 0) {
                    document.getElementById('appointments-table').innerHTML = 
                        '<tr><td colspan="8" class="text-center">No appointment data available</td></tr>';
                    document.getElementById('appointmentSearchStats').style.display = 'none';
                    return;
                }
                
                displayAppointments(appointments);
                showAppointmentSearchStats(appointments.length);
                
            } catch (error) {
                console.error('Failed to load appointment data:', error);
                document.getElementById('appointments-table').innerHTML = 
                    '<tr><td colspan="8" class="text-danger">Failed to load, check API connection</td></tr>';
            }
        }
        
        // Display appointments
        function displayAppointments(appointments) {
            if (appointments.length === 0) {
                document.getElementById('appointments-table').innerHTML = 
                    '<tr><td colspan="8" class="text-center">No appointments found</td></tr>';
                return;
            }
            
            let html = '';
            appointments.forEach(appointment => {
                let statusBadge;
                if (appointment.status === 'Scheduled') {
                    statusBadge = '<span class="badge bg-warning">Scheduled</span>';
                } else if (appointment.status === 'Completed') {
                    statusBadge = '<span class="badge bg-success">Completed</span>';
                } else if (appointment.status === 'Cancelled') {
                    statusBadge = '<span class="badge bg-danger">Cancelled</span>';
                } else {
                    statusBadge = `<span class="badge bg-secondary">${appointment.status}</span>`;
                }
                
                html += `
                    <tr>
                        <td>A${appointment.appointment_id}</td>
                        <td>${appointment.appointment_date || '--'}</td>
                        <td>${appointment.appointment_time || '--'}</td>
                        <td>${appointment.patient_first_name || ''} ${appointment.patient_last_name || ''}</td>
                        <td>${appointment.doctor_first_name || ''} ${appointment.doctor_last_name || ''}</td>
                        <td>${appointment.reason_for_visit || 'Regular Checkup'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewAppointment(${appointment.appointment_id})">View</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editAppointment(${appointment.appointment_id})">Edit</button>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('appointments-table').innerHTML = html;
        }
        
        // Show appointment search stats
        function showAppointmentSearchStats(count) {
            document.getElementById('appointmentSearchStats').style.display = 'block';
            document.getElementById('appointmentCount').textContent = count;
        }
        
        // Toggle advanced appointment search
        function toggleAdvancedAppointmentSearch() {
            const advancedSearch = document.getElementById('advancedAppointmentSearch');
            if (advancedSearch.style.display === 'none') {
                advancedSearch.style.display = 'block';
            } else {
                advancedSearch.style.display = 'none';
            }
        }
        
        // Search appointments
        function searchAppointments() {
            const appointmentId = document.getElementById('searchAppointmentId').value.replace(/\D/g, '');
            const patientName = document.getElementById('searchAppointmentPatient').value.toLowerCase();
            const doctorName = document.getElementById('searchAppointmentDoctor').value.toLowerCase();
            const status = document.getElementById('searchAppointmentStatus').value;
            const dateFrom = document.getElementById('searchAppointmentDateFrom').value;
            const dateTo = document.getElementById('searchAppointmentDateTo').value;
            const timeSlot = document.getElementById('searchAppointmentTime').value;
            const reason = document.getElementById('searchAppointmentReason').value;
            const patientId = document.getElementById('searchAppointmentPatientId').value.replace(/\D/g, '');
            const doctorId = document.getElementById('searchAppointmentDoctorId').value.replace(/\D/g, '');
            
            let filteredAppointments = window.allAppointments || [];
            
            // Apply filters
            if (appointmentId) {
                filteredAppointments = filteredAppointments.filter(a => 
                    a.appointment_id.toString().includes(appointmentId)
                );
            }
            
            if (patientName) {
                filteredAppointments = filteredAppointments.filter(a => {
                    const fullName = `${a.patient_first_name || ''} ${a.patient_last_name || ''}`.toLowerCase();
                    return fullName.includes(patientName);
                });
            }
            
            if (doctorName) {
                filteredAppointments = filteredAppointments.filter(a => {
                    const fullName = `${a.doctor_first_name || ''} ${a.doctor_last_name || ''}`.toLowerCase();
                    return fullName.includes(doctorName);
                });
            }
            
            if (status) {
                filteredAppointments = filteredAppointments.filter(a => a.status === status);
            }
            
            if (dateFrom) {
                filteredAppointments = filteredAppointments.filter(a => 
                    a.appointment_date >= dateFrom
                );
            }
            
            if (dateTo) {
                filteredAppointments = filteredAppointments.filter(a => 
                    a.appointment_date <= dateTo
                );
            }
            
            if (timeSlot === 'morning') {
                filteredAppointments = filteredAppointments.filter(a => {
                    const time = a.appointment_time;
                    return time >= '08:00' && time <= '12:00';
                });
            } else if (timeSlot === 'afternoon') {
                filteredAppointments = filteredAppointments.filter(a => {
                    const time = a.appointment_time;
                    return time >= '13:00' && time <= '17:00';
                });
            }
            
            if (reason) {
                filteredAppointments = filteredAppointments.filter(a => a.reason_for_visit === reason);
            }
            
            if (patientId) {
                filteredAppointments = filteredAppointments.filter(a => 
                    a.patient_id.toString().includes(patientId)
                );
            }
            
            if (doctorId) {
                filteredAppointments = filteredAppointments.filter(a => 
                    a.doctor_id.toString().includes(doctorId)
                );
            }
            
            window.filteredAppointments = filteredAppointments;
            displayAppointments(filteredAppointments);
            showAppointmentSearchStats(filteredAppointments.length);
        }
        
        // Export appointments
        function exportAppointments() {
            const appointments = window.filteredAppointments || window.allAppointments || [];
            let csvContent = "data:text/csv;charset=utf-8,Appointment ID,Date,Time,Patient ID,Patient Name,Doctor ID,Doctor Name,Reason,Status,Description\n";
            
            appointments.forEach(appointment => {
                const row = [
                    `A${appointment.appointment_id}`,
                    appointment.appointment_date || '',
                    appointment.appointment_time || '',
                    appointment.patient_id || '',
                    `${appointment.patient_first_name || ''} ${appointment.patient_last_name || ''}`,
                    appointment.doctor_id || '',
                    `${appointment.doctor_first_name || ''} ${appointment.doctor_last_name || ''}`,
                    appointment.reason_for_visit || '',
                    appointment.status || '',
                    appointment.description || ''
                ].map(field => `"${field}"`).join(",");
                
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `appointments_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ================ Billing Management with Search ================
        
        // Load billing data with search functionality
        async function loadBillingData() {
            try {
                // Use /admin/ prefix
                const bills = await apiRequest('/billing');
                
                window.allBills = bills; // Store for searching
                
                if (!bills || bills.length === 0) {
                    document.getElementById('billing-table').innerHTML = 
                        '<tr><td colspan="8" class="text-center">No billing data available</td></tr>';
                    document.getElementById('billSearchStats').style.display = 'none';
                    return;
                }
                
                // Calculate statistics
                calculateBillingStatistics(bills);
                displayBills(bills);
                showBillSearchStats(bills);
                
            } catch (error) {
                console.error('Failed to load financial data:', error);
                document.getElementById('billing-table').innerHTML = 
                    '<tr><td colspan="8" class="text-danger">Failed to load, check API connection</td></tr>';
            }
        }
        
        // Calculate billing statistics
        function calculateBillingStatistics(bills) {
            const totalIncome = bills
                .filter(bill => bill.payment_status === 'Paid')
                .reduce((sum, bill) => sum + (bill.amount || 0), 0);
            
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            const monthBills = bills.filter(bill => {
                if (!bill.bill_date) return false;
                const billDate = new Date(bill.bill_date);
                return billDate.getMonth() + 1 === currentMonth && 
                       billDate.getFullYear() === currentYear &&
                       bill.payment_status === 'Paid';
            });
            
            const monthIncome = monthBills.reduce((sum, bill) => sum + (bill.amount || 0), 0);
            
            const pendingBills = bills.filter(bill => bill.payment_status !== 'Paid');
            const pendingIncome = pendingBills.reduce((sum, bill) => sum + (bill.amount || 0), 0);
            
            const avgBill = bills.length > 0 ? 
                bills.reduce((sum, bill) => sum + (bill.amount || 0), 0) / bills.length : 0;
            
            // Update statistics cards
            document.getElementById('total-income').textContent = `¬•${totalIncome.toLocaleString()}`;
            document.getElementById('month-income').textContent = `¬•${monthIncome.toLocaleString()}`;
            document.getElementById('pending-income').textContent = `¬•${pendingIncome.toLocaleString()}`;
            document.getElementById('avg-bill').textContent = `¬•${avgBill.toFixed(2)}`;
        }
        
        // Display bills
        function displayBills(bills) {
            if (bills.length === 0) {
                document.getElementById('billing-table').innerHTML = 
                    '<tr><td colspan="8" class="text-center">No bills found</td></tr>';
                return;
            }
            
            let html = '';
            bills.forEach(bill => {
                let statusBadge;
                if (bill.payment_status === 'Paid') {
                    statusBadge = '<span class="badge bg-success">Paid</span>';
                } else if (bill.payment_status === 'Pending') {
                    statusBadge = '<span class="badge bg-danger">Pending</span>';
                } else {
                    statusBadge = `<span class="badge bg-secondary">${bill.payment_status}</span>`;
                }
                
                html += `
                    <tr>
                        <td>B${bill.bill_id}</td>
                        <td>${bill.bill_date || '--'}</td>
                        <td>${bill.patient_first_name || ''} ${bill.patient_last_name || ''}</td>
                        <td>${bill.description || 'Medical Fee'}</td>
                        <td>¬•${(bill.amount || 0).toFixed(2)}</td>
                        <td>${bill.payment_method || '--'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBill(${bill.bill_id})">View</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editBill(${bill.bill_id})">Edit</button>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('billing-table').innerHTML = html;
        }
        
        // Show bill search stats
        function showBillSearchStats(bills) {
            document.getElementById('billSearchStats').style.display = 'block';
            document.getElementById('billCount').textContent = bills.length;
            
            const totalAmount = bills.reduce((sum, bill) => sum + (bill.amount || 0), 0);
            document.getElementById('billTotalAmount').textContent = totalAmount.toFixed(2);
        }
        
        // Search bills
        function searchBills() {
            const billId = document.getElementById('searchBillId').value.replace(/\D/g, '');
            const patientName = document.getElementById('searchBillPatient').value.toLowerCase();
            const status = document.getElementById('searchBillStatus').value;
            const paymentMethod = document.getElementById('searchBillPaymentMethod').value;
            const dateFrom = document.getElementById('searchBillDateFrom').value;
            const dateTo = document.getElementById('searchBillDateTo').value;
            const amountRange = document.getElementById('searchBillAmount').value;
            
            let filteredBills = window.allBills || [];
            
            // Apply filters
            if (billId) {
                filteredBills = filteredBills.filter(b => 
                    b.bill_id.toString().includes(billId)
                );
            }
            
            if (patientName) {
                filteredBills = filteredBills.filter(b => {
                    const fullName = `${b.patient_first_name || ''} ${b.patient_last_name || ''}`.toLowerCase();
                    return fullName.includes(patientName);
                });
            }
            
            if (status) {
                filteredBills = filteredBills.filter(b => b.payment_status === status);
            }
            
            if (paymentMethod) {
                filteredBills = filteredBills.filter(b => b.payment_method === paymentMethod);
            }
            
            if (dateFrom) {
                filteredBills = filteredBills.filter(b => 
                    b.bill_date >= dateFrom
                );
            }
            
            if (dateTo) {
                filteredBills = filteredBills.filter(b => 
                    b.bill_date <= dateTo
                );
            }
            
            if (amountRange) {
                const [minAmount, maxAmount] = amountRange === '5000+' ? [5000, Infinity] : amountRange.split('-').map(Number);
                filteredBills = filteredBills.filter(b => {
                    const amount = b.amount || 0;
                    return amount >= minAmount && (maxAmount === Infinity ? true : amount <= maxAmount);
                });
            }
            
            window.filteredBills = filteredBills;
            displayBills(filteredBills);
            showBillSearchStats(filteredBills);
        }
        
        // Export bills
        function exportBills() {
            const bills = window.filteredBills || window.allBills || [];
            let csvContent = "data:text/csv;charset=utf-8,Bill ID,Date,Patient ID,Patient Name,Description,Amount,Payment Method,Status,Notes\n";
            
            bills.forEach(bill => {
                const row = [
                    `B${bill.bill_id}`,
                    bill.bill_date || '',
                    bill.patient_id || '',
                    `${bill.patient_first_name || ''} ${bill.patient_last_name || ''}`,
                    bill.description || '',
                    bill.amount || 0,
                    bill.payment_method || '',
                    bill.payment_status || '',
                    bill.notes || ''
                ].map(field => `"${field}"`).join(",");
                
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `bills_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ================ Reports & Analytics Functions ================
        
        // Initialize reports
        function initializeReports() {
            // Set default date range (last 30 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30);
            
            document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
            
            document.getElementById('reportResults').innerHTML = 
                '<p class="text-center text-muted">Select a report to generate results</p>';
        }
        
        // Generate monthly report
        async function generateMonthlyReport() {
            try {
                // Get data for the current month
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                
                const [patients, doctors, appointments, bills] = await parallelApiRequests([
                    { endpoint: '/patients' },
                    { endpoint: '/doctors' },
                    { endpoint: '/appointments' },
                    { endpoint: '/billing' }
                ]);
                
                // Filter data for current month
                const monthPatients = patients.filter(p => {
                    if (!p.registration_date) return false;
                    const regDate = new Date(p.registration_date);
                    return regDate.getMonth() + 1 === currentMonth && 
                           regDate.getFullYear() === currentYear;
                });
                
                const monthAppointments = appointments.filter(a => {
                    if (!a.appointment_date) return false;
                    const apptDate = new Date(a.appointment_date);
                    return apptDate.getMonth() + 1 === currentMonth && 
                           apptDate.getFullYear() === currentYear;
                });
                
                const monthBills = bills.filter(b => {
                    if (!b.bill_date) return false;
                    const billDate = new Date(b.bill_date);
                    return billDate.getMonth() + 1 === currentMonth && 
                           billDate.getFullYear() === currentYear;
                });
                
                // Calculate statistics
                const newPatientsCount = monthPatients.length;
                const totalAppointments = monthAppointments.length;
                const completedAppointments = monthAppointments.filter(a => a.status === 'Completed').length;
                const cancelledAppointments = monthAppointments.filter(a => a.status === 'Cancelled').length;
                
                const paidBills = monthBills.filter(b => b.payment_status === 'Paid');
                const totalRevenue = paidBills.reduce((sum, b) => sum + (b.amount || 0), 0);
                const pendingRevenue = monthBills
                    .filter(b => b.payment_status !== 'Paid')
                    .reduce((sum, b) => sum + (b.amount || 0), 0);
                
                // Generate report HTML
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                
                const reportHtml = `
                    <h5>Monthly Report: ${monthNames[currentMonth - 1]} ${currentYear}</h5>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Patient Statistics</h6>
                                    <p><strong>New Patients:</strong> ${newPatientsCount}</p>
                                    <p><strong>Total Patients:</strong> ${patients.length}</p>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Appointment Statistics</h6>
                                    <p><strong>Total Appointments:</strong> ${totalAppointments}</p>
                                    <p><strong>Completed:</strong> ${completedAppointments}</p>
                                    <p><strong>Cancelled:</strong> ${cancelledAppointments}</p>
                                    <p><strong>Completion Rate:</strong> ${totalAppointments > 0 ? Math.round((completedAppointments / totalAppointments) * 100) : 0}%</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Financial Statistics</h6>
                                    <p><strong>Total Revenue:</strong> ¬•${totalRevenue.toFixed(2)}</p>
                                    <p><strong>Pending Revenue:</strong> ¬•${pendingRevenue.toFixed(2)}</p>
                                    <p><strong>Average Bill:</strong> ¬•${paidBills.length > 0 ? (totalRevenue / paidBills.length).toFixed(2) : '0.00'}</p>
                                    <p><strong>Total Bills:</strong> ${monthBills.length}</p>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Doctor Statistics</h6>
                                    <p><strong>Total Doctors:</strong> ${doctors.length}</p>
                                    <p><strong>Top Specializations:</strong></p>
                                    <ul>
                                        ${getTopSpecializations(doctors)}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="exportMonthlyReport()">üì• Export Report</button>
                    </div>
                `;
                
                document.getElementById('reportResults').innerHTML = reportHtml;
                
            } catch (error) {
                console.error('Failed to generate monthly report:', error);
                document.getElementById('reportResults').innerHTML = 
                    '<p class="text-danger">Failed to generate report. Please check API connection.</p>';
            }
        }
        
        // Get top specializations
        function getTopSpecializations(doctors) {
            const specializations = {};
            doctors.forEach(doctor => {
                const spec = doctor.specialization || 'Unknown';
                specializations[spec] = (specializations[spec] || 0) + 1;
            });
            
            // Sort by count
            const sortedSpecs = Object.entries(specializations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let html = '';
            sortedSpecs.forEach(([spec, count]) => {
                html += `<li>${spec}: ${count} doctors</li>`;
            });
            
            return html;
        }
        
        // Export monthly report
        function exportMonthlyReport() {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            const reportData = `Monthly Report: ${monthNames[currentMonth - 1]} ${currentYear}\n\n` +
                `Generated on: ${new Date().toLocaleDateString()}\n` +
                `This is a summary report. For detailed data, please use the export functions in each management section.`;
            
            const blob = new Blob([reportData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `monthly_report_${currentYear}_${currentMonth}.txt`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // Generate date range report
        async function generateDateRangeReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (startDate > endDate) {
                alert('Start date cannot be after end date');
                return;
            }
            
            try {
                const [patients, appointments, bills] = await parallelApiRequests([
                    { endpoint: '/patients' },
                    { endpoint: '/appointments' },
                    { endpoint: '/billing' }
                ]);
                
                // Filter data for date range
                const rangePatients = patients.filter(p => {
                    if (!p.registration_date) return false;
                    return p.registration_date >= startDate && p.registration_date <= endDate;
                });
                
                const rangeAppointments = appointments.filter(a => {
                    if (!a.appointment_date) return false;
                    return a.appointment_date >= startDate && a.appointment_date <= endDate;
                });
                
                const rangeBills = bills.filter(b => {
                    if (!b.bill_date) return false;
                    return b.bill_date >= startDate && b.bill_date <= endDate;
                });
                
                // Calculate statistics
                const newPatientsCount = rangePatients.length;
                const totalAppointments = rangeAppointments.length;
                const completedAppointments = rangeAppointments.filter(a => a.status === 'Completed').length;
                
                const paidBills = rangeBills.filter(b => b.payment_status === 'Paid');
                const totalRevenue = paidBills.reduce((sum, b) => sum + (b.amount || 0), 0);
                
                // Generate report
                const reportHtml = `
                    <h5>Date Range Report: ${startDate} to ${endDate}</h5>
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body text-center">
                                    <h1 class="display-4 text-primary">${newPatientsCount}</h1>
                                    <p class="text-muted">New Patients</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body text-center">
                                    <h1 class="display-4 text-success">${totalAppointments}</h1>
                                    <p class="text-muted">Appointments</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body text-center">
                                    <h1 class="display-4 text-warning">¬•${totalRevenue.toFixed(2)}</h1>
                                    <p class="text-muted">Revenue</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h6>Detailed Statistics</h6>
                            <p><strong>Appointment Completion Rate:</strong> ${totalAppointments > 0 ? Math.round((completedAppointments / totalAppointments) * 100) : 0}%</p>
                            <p><strong>Average Revenue per Patient:</strong> ¬•${newPatientsCount > 0 ? (totalRevenue / newPatientsCount).toFixed(2) : '0.00'}</p>
                            <p><strong>Total Bills Generated:</strong> ${rangeBills.length}</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportResults').innerHTML = reportHtml;
                
            } catch (error) {
                console.error('Failed to generate date range report:', error);
                document.getElementById('reportResults').innerHTML = 
                    '<p class="text-danger">Failed to generate report. Please check API connection.</p>';
            }
        }
        
        // Generate patient demographics report
        async function generatePatientDemographics() {
            try {
                const patients = await apiRequest('/patients');
                
                // Calculate demographics
                let maleCount = 0;
                let femaleCount = 0;
                let otherCount = 0;
                const ageGroups = {
                    '0-18': 0,
                    '19-35': 0,
                    '36-60': 0,
                    '61+': 0
                };
                
                patients.forEach(patient => {
                    // Gender count
                    if (patient.gender === 'M') {
                        maleCount++;
                    } else if (patient.gender === 'F') {
                        femaleCount++;
                    } else {
                        otherCount++;
                    }
                    
                    // Age groups
                    if (patient.date_of_birth) {
                        const birthDate = new Date(patient.date_of_birth);
                        const today = new Date();
                        const age = today.getFullYear() - birthDate.getFullYear();
                        
                        if (age <= 18) {
                            ageGroups['0-18']++;
                        } else if (age <= 35) {
                            ageGroups['19-35']++;
                        } else if (age <= 60) {
                            ageGroups['36-60']++;
                        } else {
                            ageGroups['61+']++;
                        }
                    }
                });
                
                const reportHtml = `
                    <h5>Patient Demographics Report</h5>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Gender Distribution</h6>
                                    <p><strong>Male:</strong> ${maleCount} (${patients.length > 0 ? Math.round((maleCount / patients.length) * 100) : 0}%)</p>
                                    <p><strong>Female:</strong> ${femaleCount} (${patients.length > 0 ? Math.round((femaleCount / patients.length) * 100) : 0}%)</p>
                                    <p><strong>Other/Unknown:</strong> ${otherCount} (${patients.length > 0 ? Math.round((otherCount / patients.length) * 100) : 0}%)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Age Distribution</h6>
                                    <p><strong>0-18 years:</strong> ${ageGroups['0-18']}</p>
                                    <p><strong>19-35 years:</strong> ${ageGroups['19-35']}</p>
                                    <p><strong>36-60 years:</strong> ${ageGroups['36-60']}</p>
                                    <p><strong>61+ years:</strong> ${ageGroups['61+']}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h6>Summary</h6>
                            <p><strong>Total Patients:</strong> ${patients.length}</p>
                            <p><strong>Average Registration Date:</strong> ${getAverageRegistrationDate(patients)}</p>
                            <p><strong>Most Common Insurance Providers:</strong></p>
                            <ul>
                                ${getTopInsuranceProviders(patients)}
                            </ul>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportResults').innerHTML = reportHtml;
                
            } catch (error) {
                console.error('Failed to generate demographics report:', error);
                document.getElementById('reportResults').innerHTML = 
                    '<p class="text-danger">Failed to generate report. Please check API connection.</p>';
            }
        }
        
        // Get average registration date
        function getAverageRegistrationDate(patients) {
            const validDates = patients
                .filter(p => p.registration_date)
                .map(p => new Date(p.registration_date).getTime());
            
            if (validDates.length === 0) return 'Not available';
            
            const averageTimestamp = validDates.reduce((sum, date) => sum + date, 0) / validDates.length;
            return new Date(averageTimestamp).toLocaleDateString();
        }
        
        // Get top insurance providers
        function getTopInsuranceProviders(patients) {
            const providers = {};
            patients.forEach(patient => {
                const provider = patient.insurance_provider || 'No Insurance';
                providers[provider] = (providers[provider] || 0) + 1;
            });
            
            // Sort by count
            const sortedProviders = Object.entries(providers)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let html = '';
            sortedProviders.forEach(([provider, count]) => {
                const percentage = patients.length > 0 ? Math.round((count / patients.length) * 100) : 0;
                html += `<li>${provider}: ${count} patients (${percentage}%)</li>`;
            });
            
            return html;
        }
        
        // Generate doctor performance report
        async function generateDoctorPerformance() {
            try {
                const [doctors, appointments] = await parallelApiRequests([
                    { endpoint: '/doctors' },
                    { endpoint: '/appointments' }
                ]);
                
                // Calculate doctor performance
                const doctorPerformance = doctors.map(doctor => {
                    const doctorAppointments = appointments.filter(a => a.doctor_id === doctor.doctor_id);
                    const completedAppointments = doctorAppointments.filter(a => a.status === 'Completed').length;
                    
                    return {
                        id: doctor.doctor_id,
                        name: `Dr. ${doctor.first_name} ${doctor.last_name}`,
                        specialization: doctor.specialization || 'Unknown',
                        totalAppointments: doctorAppointments.length,
                        completedAppointments: completedAppointments,
                        completionRate: doctorAppointments.length > 0 ? 
                            Math.round((completedAppointments / doctorAppointments.length) * 100) : 0
                    };
                });
                
                // Sort by completion rate (descending)
                doctorPerformance.sort((a, b) => b.completionRate - a.completionRate);
                
                let performanceHtml = '';
                doctorPerformance.forEach(doctor => {
                    performanceHtml += `
                        <tr>
                            <td>${doctor.name}</td>
                            <td>${doctor.specialization}</td>
                            <td>${doctor.totalAppointments}</td>
                            <td>${doctor.completedAppointments}</td>
                            <td>${doctor.completionRate}%</td>
                        </tr>
                    `;
                });
                
                const reportHtml = `
                    <h5>Doctor Performance Report</h5>
                    <div class="table-responsive mt-4">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Doctor Name</th>
                                    <th>Specialization</th>
                                    <th>Total Appointments</th>
                                    <th>Completed Appointments</th>
                                    <th>Completion Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${performanceHtml}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('reportResults').innerHTML = reportHtml;
                
            } catch (error) {
                console.error('Failed to generate doctor performance report:', error);
                document.getElementById('reportResults').innerHTML = 
                    '<p class="text-danger">Failed to generate report. Please check API connection.</p>';
            }
        }
        
        // Generate appointment analysis
        async function generateAppointmentAnalysis() {
            try {
                const appointments = await apiRequest('/appointments');
                
                // Calculate statistics by status
                const statusCounts = {};
                const reasonCounts = {};
                const monthlyCounts = {};
                
                appointments.forEach(appointment => {
                    // Status counts
                    const status = appointment.status || 'Unknown';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                    
                    // Reason counts
                    const reason = appointment.reason_for_visit || 'Unknown';
                    reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
                    
                    // Monthly counts
                    if (appointment.appointment_date) {
                        const date = new Date(appointment.appointment_date);
                        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        monthlyCounts[monthYear] = (monthlyCounts[monthYear] || 0) + 1;
                    }
                });
                
                // Get top reasons
                const topReasons = Object.entries(reasonCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                let reasonsHtml = '';
                topReasons.forEach(([reason, count]) => {
                    const percentage = appointments.length > 0 ? Math.round((count / appointments.length) * 100) : 0;
                    reasonsHtml += `<li>${reason}: ${count} appointments (${percentage}%)</li>`;
                });
                
                const reportHtml = `
                    <h5>Appointment Analysis Report</h5>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Status Distribution</h6>
                                    <p><strong>Total Appointments:</strong> ${appointments.length}</p>
                                    <p><strong>Scheduled:</strong> ${statusCounts['Scheduled'] || 0}</p>
                                    <p><strong>Completed:</strong> ${statusCounts['Completed'] || 0}</p>
                                    <p><strong>Cancelled:</strong> ${statusCounts['Cancelled'] || 0}</p>
                                    <p><strong>In Progress:</strong> ${statusCounts['In Progress'] || 0}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Top Appointment Reasons</h6>
                                    <ul>
                                        ${reasonsHtml}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportResults').innerHTML = reportHtml;
                
            } catch (error) {
                console.error('Failed to generate appointment analysis:', error);
                document.getElementById('reportResults').innerHTML = 
                    '<p class="text-danger">Failed to generate report. Please check API connection.</p>';
            }
        }
        
        // Generate financial summary
        async function generateFinancialSummary() {
            try {
                const bills = await apiRequest('/billing');
                
                // Calculate statistics
                const paidBills = bills.filter(b => b.payment_status === 'Paid');
                const pendingBills = bills.filter(b => b.payment_status !== 'Paid');
                
                const totalRevenue = paidBills.reduce((sum, b) => sum + (b.amount || 0), 0);
                const pendingRevenue = pendingBills.reduce((sum, b) => sum + (b.amount || 0), 0);
                
                // Calculate by payment method
                const paymentMethodStats = {};
                paidBills.forEach(bill => {
                    const method = bill.payment_method || 'Unknown';
                    paymentMethodStats[method] = (paymentMethodStats[method] || 0) + (bill.amount || 0);
                });
                
                // Calculate monthly revenue
                const monthlyRevenue = {};
                paidBills.forEach(bill => {
                    if (bill.bill_date) {
                        const date = new Date(bill.bill_date);
                        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        monthlyRevenue[monthYear] = (monthlyRevenue[monthYear] || 0) + (bill.amount || 0);
                    }
                });
                
                // Sort months
                const sortedMonths = Object.entries(monthlyRevenue)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .slice(-6); // Last 6 months
                
                let monthlyHtml = '';
                sortedMonths.forEach(([month, revenue]) => {
                    monthlyHtml += `<li>${month}: ¬•${revenue.toFixed(2)}</li>`;
                });
                
                const reportHtml = `
                    <h5>Financial Summary Report</h5>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Revenue Summary</h6>
                                    <p><strong>Total Revenue:</strong> ¬•${totalRevenue.toFixed(2)}</p>
                                    <p><strong>Pending Revenue:</strong> ¬•${pendingRevenue.toFixed(2)}</p>
                                    <p><strong>Total Bills:</strong> ${bills.length}</p>
                                    <p><strong>Paid Bills:</strong> ${paidBills.length}</p>
                                    <p><strong>Pending Bills:</strong> ${pendingBills.length}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Recent Monthly Revenue</h6>
                                    <ul>
                                        ${monthlyHtml}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportResults').innerHTML = reportHtml;
                
            } catch (error) {
                console.error('Failed to generate financial summary:', error);
                document.getElementById('reportResults').innerHTML = 
                    '<p class="text-danger">Failed to generate report. Please check API connection.</p>';
            }
        }
        
        // Export all data
        function exportAllData() {
            alert('This would export all system data. In a real application, this would generate a comprehensive report including all patient, doctor, appointment, and billing data.');
        }
        
        // ================ Quick Search Functions ================
        
        // Open quick patient search modal
        function openQuickPatientSearch() {
            const modal = new bootstrap.Modal(document.getElementById('quickPatientSearchModal'));
            modal.show();
        }
        
        // Open quick doctor search modal
        function openQuickDoctorSearch() {
            const modal = new bootstrap.Modal(document.getElementById('quickDoctorSearchModal'));
            modal.show();
        }
        
        // Perform quick patient search
        async function performQuickPatientSearch() {
            const searchTerm = document.getElementById('quickPatientSearch').value.toLowerCase();
            
            if (!searchTerm) {
                alert('Please enter search terms');
                return;
            }
            
            try {
                const patients = await apiRequest('/patients');
                
                const filteredPatients = patients.filter(patient => {
                    const fullName = `${patient.first_name || ''} ${patient.last_name || ''}`.toLowerCase();
                    const patientId = `p${patient.patient_id}`;
                    const phone = patient.contact_number || '';
                    const insurance = patient.insurance_provider || '';
                    
                    return fullName.includes(searchTerm) ||
                           patientId.includes(searchTerm) ||
                           phone.includes(searchTerm) ||
                           insurance.toLowerCase().includes(searchTerm);
                });
                
                displayQuickPatientResults(filteredPatients);
                
            } catch (error) {
                console.error('Failed to search patients:', error);
                document.getElementById('quickPatientResults').innerHTML = 
                    '<tr><td colspan="5" class="text-danger">Search failed</td></tr>';
            }
        }
        
        // Display quick patient results
        function displayQuickPatientResults(patients) {
            const tableBody = document.getElementById('quickPatientResults');
            
            if (patients.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No patients found</td></tr>';
                return;
            }
            
            let html = '';
            patients.slice(0, 10).forEach(patient => {
                html += `
                    <tr>
                        <td>P${patient.patient_id}</td>
                        <td>${patient.first_name} ${patient.last_name}</td>
                        <td>${patient.contact_number || '--'}</td>
                        <td>${patient.insurance_provider || '--'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewPatient(${patient.patient_id})">View</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // Perform quick doctor search
        async function performQuickDoctorSearch() {
            const searchTerm = document.getElementById('quickDoctorSearch').value.toLowerCase();
            
            if (!searchTerm) {
                alert('Please enter search terms');
                return;
            }
            
            try {
                const doctors = await apiRequest('/doctors');
                
                const filteredDoctors = doctors.filter(doctor => {
                    const fullName = `${doctor.first_name || ''} ${doctor.last_name || ''}`.toLowerCase();
                    const doctorId = `d${doctor.doctor_id}`;
                    const specialization = doctor.specialization || '';
                    const branch = doctor.hospital_branch || '';
                    
                    return fullName.includes(searchTerm) ||
                           doctorId.includes(searchTerm) ||
                           specialization.toLowerCase().includes(searchTerm) ||
                           branch.toLowerCase().includes(searchTerm);
                });
                
                displayQuickDoctorResults(filteredDoctors);
                
            } catch (error) {
                console.error('Failed to search doctors:', error);
                document.getElementById('quickDoctorResults').innerHTML = 
                    '<tr><td colspan="5" class="text-danger">Search failed</td></tr>';
            }
        }
        
        // Display quick doctor results
        function displayQuickDoctorResults(doctors) {
            const tableBody = document.getElementById('quickDoctorResults');
            
            if (doctors.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No doctors found</td></tr>';
                return;
            }
            
            let html = '';
            doctors.slice(0, 10).forEach(doctor => {
                html += `
                    <tr>
                        <td>D${doctor.doctor_id}</td>
                        <td>Dr. ${doctor.first_name} ${doctor.last_name}</td>
                        <td>${doctor.specialization || '--'}</td>
                        <td>${doctor.hospital_branch || '--'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDoctor(${doctor.doctor_id})">View</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // Perform global search
        async function performGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value;
            const category = document.getElementById('searchCategory').value;
            
            if (!searchTerm) {
                alert('Please enter search terms');
                return;
            }
            
            // Based on category, navigate to appropriate page and perform search
            if (category === 'patients' || category === 'all') {
                loadPatients();
                setTimeout(() => {
                    document.getElementById('searchPatientName').value = searchTerm;
                    searchPatients();
                }, 500);
            }
            
            if (category === 'doctors' || category === 'all') {
                loadDoctors();
                setTimeout(() => {
                    document.getElementById('searchDoctorName').value = searchTerm;
                    searchDoctors();
                }, 500);
            }
            
            if (category === 'appointments' || category === 'all') {
                loadAppointments();
                setTimeout(() => {
                    document.getElementById('searchAppointmentPatient').value = searchTerm;
                    document.getElementById('searchAppointmentDoctor').value = searchTerm;
                    searchAppointments();
                }, 500);
            }
            
            if (category === 'billing' || category === 'all') {
                loadBilling();
                setTimeout(() => {
                    document.getElementById('searchBillPatient').value = searchTerm;
                    searchBills();
                }, 500);
            }
        }
        
        // ================ Action Functions ================
        
        // View detail functions
        async function viewPatient(patientId) {
            try {
                const patient = await apiRequest(`/patients/${patientId}`);
                
                if (!patient) {
                    alert('Failed to get patient details');
                    return;
                }
                
                let genderDisplay = 'Unknown';
                if (patient.gender === 'M') {
                    genderDisplay = 'Male';
                } else if (patient.gender === 'F') {
                    genderDisplay = 'Female';
                }
                
                let age = '--';
                if (patient.date_of_birth) {
                    const birthDate = new Date(patient.date_of_birth);
                    const today = new Date();
                    age = today.getFullYear() - birthDate.getFullYear();
                }
                
                alert(`Patient Details #${patientId}\n
Name: ${patient.first_name} ${patient.last_name}\n
Gender: ${genderDisplay}\n
Age: ${age}\n
Date of Birth: ${patient.date_of_birth || 'Not filled'}\n
Phone: ${patient.contact_number || 'Not filled'}\n
Email: ${patient.email || 'Not filled'}\n
Address: ${patient.address || 'Not filled'}\n
Insurance Provider: ${patient.insurance_provider || 'Not filled'}\n
Insurance Number: ${patient.insurance_number || 'Not filled'}\n
Registration Date: ${patient.registration_date || 'Unknown'}`);
                
            } catch (error) {
                console.error('Failed to view patient details:', error);
                alert('Failed to get patient details');
            }
        }
        
        async function viewDoctor(doctorId) {
            try {
                const doctor = await apiRequest(`/doctors/${doctorId}`);
                
                if (!doctor) {
                    alert('Failed to get doctor details');
                    return;
                }
                
                alert(`Doctor Details #${doctorId}\n
Name: Dr. ${doctor.first_name} ${doctor.last_name}\n
Specialization: ${doctor.specialization || 'Not filled'}\n
Experience: ${doctor.years_experience || 0} years\n
Phone: ${doctor.phone_number || 'Not filled'}\n
Email: ${doctor.email || 'Not filled'}\n
Hospital Branch: ${doctor.hospital_branch || 'Main Hospital'}\n
Bio: ${doctor.bio || 'No bio available'}\n
Hire Date: ${doctor.hire_date || 'Unknown'}`);
                
            } catch (error) {
                console.error('Failed to view doctor details:', error);
                alert('Failed to get doctor details');
            }
        }
        
        async function viewAppointment(appointmentId) {
            try {
                const appointment = await apiRequest(`/appointments/${appointmentId}`);
                
                if (!appointment) {
                    alert('Failed to get appointment details');
                    return;
                }
                
                let statusText = '';
                if (appointment.status === 'Scheduled') {
                    statusText = 'Scheduled';
                } else if (appointment.status === 'Completed') {
                    statusText = 'Completed';
                } else if (appointment.status === 'Cancelled') {
                    statusText = 'Cancelled';
                } else {
                    statusText = appointment.status;
                }
                
                alert(`Appointment Details #${appointmentId}\n
Patient: ${appointment.patient_first_name || ''} ${appointment.patient_last_name || ''}\n
Doctor: Dr. ${appointment.doctor_first_name || ''} ${appointment.doctor_last_name || ''}\n
Date: ${appointment.appointment_date || 'Not set'}\n
Time: ${appointment.appointment_time || 'Not set'}\n
Reason: ${appointment.reason_for_visit || 'Regular Checkup'}\n
Description: ${appointment.description || 'None'}\n
Status: ${statusText}\n
Created At: ${appointment.created_at || 'Unknown'}`);
                
            } catch (error) {
                console.error('Failed to view appointment details:', error);
                alert('Failed to get appointment details');
            }
        }
        
        async function viewBill(billId) {
            try {
                const bill = await apiRequest(`/billing/${billId}`);
                
                if (!bill) {
                    alert('Failed to get bill details');
                    return;
                }
                
                let statusText = '';
                if (bill.payment_status === 'Paid') {
                    statusText = 'Paid';
                } else if (bill.payment_status === 'Pending') {
                    statusText = 'Pending';
                } else {
                    statusText = bill.payment_status;
                }
                
                alert(`Bill Details #${billId}\n
Patient: ${bill.patient_first_name || ''} ${bill.patient_last_name || ''}\n
Bill Date: ${bill.bill_date || 'Not set'}\n
Description: ${bill.description || 'Medical Fee'}\n
Amount: ¬•${(bill.amount || 0).toFixed(2)}\n
Payment Method: ${bill.payment_method || 'Not set'}\n
Status: ${statusText}\n
Notes: ${bill.notes || 'None'}\n
Created At: ${bill.created_at || 'Unknown'}`);
                
            } catch (error) {
                console.error('Failed to view bill details:', error);
                alert('Failed to get bill details');
            }
        }
        
        // Edit and delete functions
        function editPatient(patientId) {
            openPatientModal('edit', patientId);
        }
        
        async function deletePatient(patientId) {
            if (confirm(`Are you sure you want to delete patient #${patientId}? This action cannot be undone.`)) {
                try {
                    const response = await apiRequest(`/patients/${patientId}`, {
                        method: 'DELETE'
                    });
                    
                    alert('Patient deleted successfully');
                    loadPatientsData(); // Reload data
                    if (document.getElementById('dashboard-content').style.display === 'block') {
                        loadDashboardData();
                    }
                } catch (error) {
                    console.error('Failed to delete patient:', error);
                    alert('Deletion failed, please check network connection');
                }
            }
        }
        
        function editDoctor(doctorId) {
            openDoctorModal('edit', doctorId);
        }
        
        async function deleteDoctor(doctorId) {
            if (confirm(`Are you sure you want to delete doctor #${doctorId}? This action cannot be undone.`)) {
                try {
                    await apiRequest(`/doctors/${doctorId}`, {
                        method: 'DELETE'
                    });
                    
                    alert('Doctor deleted successfully');
                    loadDoctorsData(); // Reload data
                    if (document.getElementById('dashboard-content').style.display === 'block') {
                        loadDashboardData();
                    }
                } catch (error) {
                    console.error('Failed to delete doctor:', error);
                    alert('Deletion failed, please check network connection');
                }
            }
        }
        
        function editAppointment(appointmentId) {
            openAppointmentModal('edit', appointmentId);
        }
        
        function editBill(billId) {
            openBillModal('edit', billId);
        }
        
        // ================ Modal Functions ================
        
        // Patient modal
        async function openPatientModal(mode, patientId = null) {
            const modal = new bootstrap.Modal(document.getElementById('patientModal'));
            const form = document.getElementById('patientForm');
            const title = document.getElementById('patientModalTitle');
            
            // Reset form
            form.reset();
            
            if (mode === 'add') {
                title.textContent = 'Add New Patient';
                document.getElementById('patientId').value = '';
            } else if (mode === 'edit' && patientId) {
                title.textContent = 'Edit Patient Information';
                document.getElementById('patientId').value = patientId;
                
                // Load patient data
                try {
                    const patient = await apiRequest(`/patients/${patientId}`);
                    
                    if (!patient) {
                        alert('Failed to get patient data');
                        return;
                    }
                    
                    // Fill form
                    document.getElementById('patientFirstName').value = patient.first_name || '';
                    document.getElementById('patientLastName').value = patient.last_name || '';
                    document.getElementById('patientGender').value = patient.gender || '';
                    
                    if (patient.date_of_birth) {
                        // Convert date format to YYYY-MM-DD
                        const dob = new Date(patient.date_of_birth);
                        document.getElementById('patientDob').value = dob.toISOString().split('T')[0];
                    }
                    
                    document.getElementById('patientPhone').value = patient.contact_number || '';
                    document.getElementById('patientEmail').value = patient.email || '';
                    document.getElementById('patientAddress').value = patient.address || '';
                    document.getElementById('patientInsuranceProvider').value = patient.insurance_provider || '';
                    document.getElementById('patientInsuranceNumber').value = patient.insurance_number || '';
                    
                } catch (error) {
                    console.error('Failed to load patient data:', error);
                    alert('Failed to load patient data');
                    return;
                }
            }
            
            modal.show();
        }
        
        // Doctor modal
        async function openDoctorModal(mode, doctorId = null) {
            const modal = new bootstrap.Modal(document.getElementById('doctorModal'));
            const form = document.getElementById('doctorForm');
            const title = document.getElementById('doctorModalTitle');
            
            // Reset form
            form.reset();
            
            if (mode === 'add') {
                title.textContent = 'Add New Doctor';
                document.getElementById('doctorId').value = '';
            } else if (mode === 'edit' && doctorId) {
                title.textContent = 'Edit Doctor Information';
                document.getElementById('doctorId').value = doctorId;
                
                // Load doctor data
                try {
                    const doctor = await apiRequest(`/doctors/${doctorId}`);
                    
                    if (!doctor) {
                        alert('Failed to get doctor data');
                        return;
                    }
                    
                    // Fill form
                    document.getElementById('doctorFirstName').value = doctor.first_name || '';
                    document.getElementById('doctorLastName').value = doctor.last_name || '';
                    document.getElementById('doctorSpecialization').value = doctor.specialization || '';
                    document.getElementById('doctorPhone').value = doctor.phone_number || '';
                    document.getElementById('doctorEmail').value = doctor.email || '';
                    document.getElementById('doctorExperience').value = doctor.years_experience || '';
                    document.getElementById('doctorBranch').value = doctor.hospital_branch || '';
                    document.getElementById('doctorBio').value = doctor.bio || '';
                    
                } catch (error) {
                    console.error('Failed to load doctor data:', error);
                    alert('Failed to load doctor data');
                    return;
                }
            }
            
            modal.show();
        }
        
        // Appointment modal
        async function openAppointmentModal(mode, appointmentId = null) {
            const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
            const form = document.getElementById('appointmentForm');
            const title = document.getElementById('appointmentModalTitle');
            
            // Reset form
            form.reset();
            
            // Load patient and doctor options
            await loadPatientOptions();
            await loadDoctorOptions();
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('appointmentDate').value = tomorrow.toISOString().split('T')[0];
            
            if (mode === 'add') {
                title.textContent = 'Schedule New Appointment';
                document.getElementById('appointmentId').value = '';
            } else if (mode === 'edit' && appointmentId) {
                title.textContent = 'Edit Appointment Information';
                document.getElementById('appointmentId').value = appointmentId;
                
                // Load appointment data
                try {
                    const appointment = await apiRequest(`/appointments/${appointmentId}`);
                    
                    if (!appointment) {
                        alert('Failed to get appointment data');
                        return;
                    }
                    
                    // Fill form
                    document.getElementById('appointmentPatient').value = appointment.patient_id || '';
                    document.getElementById('appointmentDoctor').value = appointment.doctor_id || '';
                    
                    if (appointment.appointment_date) {
                        document.getElementById('appointmentDate').value = appointment.appointment_date;
                    }
                    
                    document.getElementById('appointmentTime').value = appointment.appointment_time || '';
                    document.getElementById('appointmentReason').value = appointment.reason_for_visit || 'Regular Checkup';
                    document.getElementById('appointmentDescription').value = appointment.description || '';
                    document.getElementById('appointmentStatus').value = appointment.status || 'Scheduled';
                    
                } catch (error) {
                    console.error('Failed to load appointment data:', error);
                    alert('Failed to load appointment data');
                    return;
                }
            }
            
            modal.show();
        }
        
        // Bill modal
        async function openBillModal(mode, billId = null) {
            const modal = new bootstrap.Modal(document.getElementById('billModal'));
            const form = document.getElementById('billForm');
            const title = document.getElementById('billModalTitle');
            
            // Reset form
            form.reset();
            
            // Load patient options
            await loadBillPatientOptions();
            
            // Set default date to today
            const today = new Date();
            document.getElementById('billDate').value = today.toISOString().split('T')[0];
            
            if (mode === 'add') {
                title.textContent = 'Create Bill';
                document.getElementById('billId').value = '';
            } else if (mode === 'edit' && billId) {
                title.textContent = 'Edit Bill Information';
                document.getElementById('billId').value = billId;
                
                // Load bill data
                try {
                    const bill = await apiRequest(`/billing/${billId}`);
                    
                    if (!bill) {
                        alert('Failed to get bill data');
                        return;
                    }
                    
                    // Fill form
                    document.getElementById('billPatient').value = bill.patient_id || '';
                    
                    if (bill.bill_date) {
                        document.getElementById('billDate').value = bill.bill_date;
                    }
                    
                    document.getElementById('billDescription').value = bill.description || '';
                    document.getElementById('billAmount').value = bill.amount || 0;
                    document.getElementById('billPaymentMethod').value = bill.payment_method || '';
                    
                    // Convert status value
                    let statusValue = bill.payment_status || 'Pending';
                    if (statusValue === 'Paid') {
                        statusValue = 'Paid';
                    } else if (statusValue === 'Cancelled') {
                        statusValue = 'Cancelled';
                    } else {
                        statusValue = 'Pending';
                    }
                    
                    document.getElementById('billStatus').value = statusValue;
                    document.getElementById('billNotes').value = bill.notes || '';
                    
                } catch (error) {
                    console.error('Failed to load bill data:', error);
                    alert('Failed to load bill data');
                    return;
                }
            }
            
            modal.show();
        }
        
        // Load patient options (for appointments)
        async function loadPatientOptions() {
            try {
                const patients = await apiRequest('/patients');
                const select = document.getElementById('appointmentPatient');
                
                // Clear all options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Add patient options
                if (patients) {
                    patients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient.patient_id;
                        option.textContent = `${patient.first_name} ${patient.last_name} (P${patient.patient_id})`;
                        select.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Failed to load patient options:', error);
            }
        }
        
        // Load patient options (for bills)
        async function loadBillPatientOptions() {
            try {
                const patients = await apiRequest('/patients');
                const select = document.getElementById('billPatient');
                
                // Clear all options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Add patient options
                if (patients) {
                    patients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient.patient_id;
                        option.textContent = `${patient.first_name} ${patient.last_name} (P${patient.patient_id})`;
                        select.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Failed to load patient options:', error);
            }
        }
        
        // Load doctor options
        async function loadDoctorOptions() {
            try {
                const doctors = await apiRequest('/doctors');
                const select = document.getElementById('appointmentDoctor');
                
                // Clear all options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Add doctor options
                if (doctors) {
                    doctors.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.doctor_id;
                        option.textContent = `Dr. ${doctor.first_name} ${doctor.last_name} - ${doctor.specialization}`;
                        select.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Failed to load doctor options:', error);
            }
        }
        
        // ================ Form Submission Handling ================
        
        // Patient form submission
        document.getElementById('patientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const patientId = document.getElementById('patientId').value;
            const mode = patientId ? 'edit' : 'add';
            
            const formData = {
                first_name: document.getElementById('patientFirstName').value.trim(),
                last_name: document.getElementById('patientLastName').value.trim(),
                gender: document.getElementById('patientGender').value,
                date_of_birth: document.getElementById('patientDob').value,
                contact_number: document.getElementById('patientPhone').value.trim(),
                email: document.getElementById('patientEmail').value.trim(),
                address: document.getElementById('patientAddress').value.trim(),
                insurance_provider: document.getElementById('patientInsuranceProvider').value.trim(),
                insurance_number: document.getElementById('patientInsuranceNumber').value.trim()
            };
            
            // Validate required fields
            if (!formData.first_name || !formData.last_name || !formData.contact_number) {
                alert('Please fill all required fields (first name, last name, phone number)');
                return;
            }
            
            try {
                let response;
                if (mode === 'add') {
                    // Add patient - use /admin/ prefix
                    response = await apiRequest('/patients', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Edit patient - use /admin/ prefix
                    response = await apiRequest(`/patients/${patientId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('patientModal'));
                modal.hide();
                
                // Show success message
                alert(mode === 'add' ? 'Patient added successfully!' : 'Patient information updated successfully!');
                
                // Refresh data
                if (document.getElementById('patients-content').style.display === 'block') {
                    loadPatientsData();
                } else {
                    loadDashboardData();
                }
                
            } catch (error) {
                console.error('Failed to save patient:', error);
                alert(`Save failed: ${error.message}`);
            }
        });
        
        // Doctor form submission
        document.getElementById('doctorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const doctorId = document.getElementById('doctorId').value;
            const mode = doctorId ? 'edit' : 'add';
            
            const formData = {
                first_name: document.getElementById('doctorFirstName').value.trim(),
                last_name: document.getElementById('doctorLastName').value.trim(),
                specialization: document.getElementById('doctorSpecialization').value,
                phone_number: document.getElementById('doctorPhone').value.trim(),
                email: document.getElementById('doctorEmail').value.trim(),
                years_experience: document.getElementById('doctorExperience').value ? 
                                  parseInt(document.getElementById('doctorExperience').value) : null,
                hospital_branch: document.getElementById('doctorBranch').value,
                bio: document.getElementById('doctorBio').value.trim()
            };
            
            // Validate required fields
            if (!formData.first_name || !formData.last_name || !formData.specialization || 
                !formData.phone_number || !formData.hospital_branch) {
                alert('Please fill all required fields');
                return;
            }
            
            try {
                let response;
                if (mode === 'add') {
                    // Add doctor - use /admin/ prefix
                    response = await apiRequest('/doctors', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Edit doctor - use /admin/ prefix
                    response = await apiRequest(`/doctors/${doctorId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('doctorModal'));
                modal.hide();
                
                // Show success message
                alert(mode === 'add' ? 'Doctor added successfully!' : 'Doctor information updated successfully!');
                
                // Refresh data
                if (document.getElementById('doctors-content').style.display === 'block') {
                    loadDoctorsData();
                } else {
                    loadDashboardData();
                }
                
            } catch (error) {
                console.error('Failed to save doctor:', error);
                alert(`Save failed: ${error.message}`);
            }
        });
        
        // Appointment form submission
        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const appointmentId = document.getElementById('appointmentId').value;
            const mode = appointmentId ? 'edit' : 'add';
            
            const formData = {
                patient_id: parseInt(document.getElementById('appointmentPatient').value),
                doctor_id: parseInt(document.getElementById('appointmentDoctor').value),
                appointment_date: document.getElementById('appointmentDate').value,
                appointment_time: document.getElementById('appointmentTime').value,
                reason_for_visit: document.getElementById('appointmentReason').value,
                description: document.getElementById('appointmentDescription').value.trim(),
                status: document.getElementById('appointmentStatus').value
            };
            
            // Validate required fields
            if (!formData.patient_id || !formData.doctor_id || !formData.appointment_date || 
                !formData.appointment_time || !formData.reason_for_visit || !formData.status) {
                alert('Please fill all required fields');
                return;
            }
            
            try {
                let response;
                if (mode === 'add') {
                    // Add appointment - use /admin/ prefix
                    response = await apiRequest('/appointments', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Edit appointment - use /admin/ prefix
                    response = await apiRequest(`/appointments/${appointmentId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
                modal.hide();
                
                // Show success message
                alert(mode === 'add' ? 'Appointment scheduled successfully!' : 'Appointment information updated successfully!');
                
                // Refresh data
                if (document.getElementById('appointments-content').style.display === 'block') {
                    loadAppointmentsData();
                } else {
                    loadDashboardData();
                }
                
            } catch (error) {
                console.error('Failed to save appointment:', error);
                alert(`Save failed: ${error.message}`);
            }
        });
        
        // Bill form submission
        document.getElementById('billForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const billId = document.getElementById('billId').value;
            const mode = billId ? 'edit' : 'add';
            
            const formData = {
                patient_id: parseInt(document.getElementById('billPatient').value),
                bill_date: document.getElementById('billDate').value,
                description: document.getElementById('billDescription').value.trim(),
                amount: parseFloat(document.getElementById('billAmount').value),
                payment_method: document.getElementById('billPaymentMethod').value,
                payment_status: document.getElementById('billStatus').value,
                notes: document.getElementById('billNotes').value.trim()
            };
            
            // Validate required fields
            if (!formData.patient_id || !formData.bill_date || !formData.description || 
                isNaN(formData.amount) || formData.amount <= 0 || !formData.payment_status) {
                alert('Please fill all required fields, and amount must be greater than 0');
                return;
            }
            
            try {
                let response;
                if (mode === 'add') {
                    // Add bill - use /admin/ prefix
                    response = await apiRequest('/billing', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Edit bill - use /admin/ prefix
                    response = await apiRequest(`/billing/${billId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('billModal'));
                modal.hide();
                
                // Show success message
                alert(mode === 'add' ? 'Bill added successfully!' : 'Bill information updated successfully!');
                
                // Refresh data
                if (document.getElementById('billing-content').style.display === 'block') {
                    loadBillingData();
                } else {
                    loadDashboardData();
                }
                
            } catch (error) {
                console.error('Failed to save bill:', error);
                alert(`Save failed: ${error.message}`);
            }
        });
        
        // ================ Initialization Functions ================
        
        // Logout
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
        
        // Execute after page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Display backend URL information
            document.getElementById('apiUrlDisplay').textContent = API_CONFIG.BASE_URL;
            
            // If mock mode is enabled, show notification
            if (API_CONFIG.MOCK_MODE) {
                showApiError('Note: Currently in mock mode, using simulated data. To use real data, set API_CONFIG.MOCK_MODE to false and ensure backend is running.');
            }
            
            // Test API connection
            testApiConnection();
            
            // Load dashboard by default
            loadDashboard();
        });
        
        // Test API connection
        async function testApiConnection() {
            try {
                // Test a simple endpoint - will automatically add /admin/ prefix
                await apiRequest('/doctors');
                console.log('‚úÖ API connection test successful');
            } catch (error) {
                console.log('‚ùå API connection test failed');
                // Error already shown via showApiError
            }
        }
    </script>
</body>
</html>